    <!DOCTYPE html>
    <html>
   <head>
    <meta charset="utf-8" />
    <link href="www/atmodweb.css" rel="stylesheet" type="text/css">
    <title>AtModWeb</title>
    </head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script>
        /*
            The whole ajax example
            $.ajax({
            // The URL for the request
            url: "post.php",
            
            // The data to send (will be converted to a query string)
            data: {
            id: 123
            },
            
            // Whether this is a POST or GET request
            type: "GET",
            
            // The type of data we expect back
            dataType : "json",
            
            // Code to run if the request succeeds;
            // the response is passed to the function
            success: function( json ) {
            $( "<h1>" ).text( json.title ).appendTo( "body" );
            $( "<div class=\"content\">").html( json.html ).appendTo( "body" );
            },
            
            // Code to run if the request fails; the raw request and
            // status codes are passed to the function
            error: function( xhr, status, errorThrown ) {
            alert( "Sorry, there was a problem!" );
            console.log( "Error: " + errorThrown );
            console.log( "Status: " + status );
            console.dir( xhr );
            },
            
            // Code to run regardless of success or failure
            complete: function( xhr, status ) {
            alert( "The request is complete!" );
            }
            
            });
        */
        var debug = true;

        $(document).ready(function(){
            $plottype_sel = $("#plottype_select");
            
            //Select elements that choose variables
            $xvar_sel = $("#xvar_select");
            $yvar_sel = $("#yvar_select");
            $zvar_sel = $("#zvar_select");
            
            //Make an object that associates selectors backwards with their name and associated bounds and log objects
            $selobj = {};
            $selobj[$xvar_sel.attr("name")] = {'sel':$("#xvar_select"),'bounds':$("#xbounds"),'log':$("#xlog")};
            $selobj[$yvar_sel.attr("name")] = {'sel':$("#yvar_select"),'bounds':$("#ybounds"),'log':$("#ylog")};
            $selobj[$zvar_sel.attr("name")] = {'sel':$("#zvar_select"),'bounds':$("#zbounds"),'log':$("#zlog")};
            
            //Selectors for related controls
            $all_var_sel = $("#xvar_select, #yvar_select, #zvar_select")
            $all_var_log = $("#xlog,#ylog,#zlog")
            $all_var_bounds = $("#xbounds,#ybounds,#zbounds")
            
            //Selector for everything
            $all_controls = $("#plottype_select, #xvar_select, #yvar_select, #zvar_select, #xlog, #ylog, #zlog, #xbounds, #ybounds, #zbounds,.dateinput,.positioninput,.dynamicinput")

            //Set up the functions to change controlstates

            //First we must set up the handler for changes on the plottype select

            //Init stuff - set debug options - temporary stuff
            $("#debugpanel").addClass("debug_on").addClass("initialize_me")
            $("#dynamicdriverdiv").addClass("initialize_me")
            $(".debug").hide() // hide debug stuff till we press F1

            //-------------------------------------------------------
            //Functions which preform repeated tasks
            //-------------------------------------------------------

            $hide_controls = function(loadstr) {
                $("#loading_message").text(loadstr)
                $("#loading").hide()
                $("#wrap").hide()
                $("#loading").fadeIn(500)
            }

            $show_controls = function () {
                $("#wrap").fadeIn(500)
                $("#loading").fadeOut(500)   
            }

            //Make a debugging console log printing thing to put in ajax error
            $generic_error_func = function (jqxhr,status,error) {
                if (debug) {console.log("Ajax failed: Server says: "+jqxhr.responseText)};
            }

            $generic_put_err = function (jqxhr,status,error) {
                if (debug == true) {
                    alert("Failed to PUT value")
                }
            }

            $generic_put_err = function (jqxhr,status,error) {
                if (debug == true) {
                    alert("Failed to GET value")
                }
            }

            $generic_ajax_alert = function (jqxhr,status,error) { 
                if (debug == true) {
                    alert("AJAX ERR: "+jqxhr.responseText);
                } 
            }

            //Need the myself to call recursively
            //$num2str = function myself  (nums) {
            //    var str = ''
            //    if ($.isArray(nums)) {
            //        //If this is an array we will have to format it approriately
            //
            //    } else {
            //
            //    }
            //}
            $format_number = function myself (num) {
                try {
                    if ( $.isArray(num) ) {
                        for (var i = 0; i < num.length; i++) {
                            num[i] = myself(num[i])
                        }
                    } else {
                        if (Math.abs(num) > 10000 || (Math.abs(num) < .00001 && num != 0)) {
                            num = num.toExponential(2)
                        } else {
                            num = num.toFixed(2) // 2 decimal places
                        }
                    }
                    return num
                } catch (e){
                    $logit(2,'Formating Number',e.name+" has be caught. Message ="+e.message)
                    return String(num)
                }
            }

            //Deal with padding zero values so things look sensible because...javascript
            $pad = function (str, max) {
                 str = str.toString();
                return str.length < max ? $pad("0" + str, max) : str;
            }

            //Nice litte convenience function for turning an array of promises/deferreds into one via $.when
            $.whenall = function(arr) { return $.when.apply($, arr); };

            //Custom Logging Function, Python Style
            $loglevel= 5; 
            $logarr = ['ATMODWEB LOG'];
            $logon = false;
            $logit = function(level,context,message) {
                var now = Date.now()
                var logstr = "["+String(now)+"]"+"["+context+"] "
                var levels = ["ERROR","WARNING","INFO","DEBUG","PEDANTIC"]
                logstr = logstr+String(levels[level-1])+": "+message
                if ($logon && $loglevel >= level) { $logarr.push(logstr) }
                if(debug && $loglevel >= level) { console.log(logstr) }
            }
            
            $cblog = function(level,evnt,message) {
                //Output a sensible callback for the event
                var callername = $(evnt.target).attr("name")
                var callerid = $(evnt.target).attr("ID")
                //console.log(String(callername),String(callerid))
                if (callername == null) {
                    $logit(level,"CALLBACK: "+callerid+':'+String(evnt.type), message)
                } else {
                    $logit(level,"CALLBACK: "+callername+':'+String(evnt.type), message)
                }
            }

            //Checks if any of the selects have Latitude,Longitude or Altitude,
            //and hides the associated control if they do (since it's then an independant variable)
            $hidePosIfNeeded = function () {

                var def = $.Deferred()
                $logit(3,"$hidePosIfNeeded","Now hiding position if needed.")
                var xvar = $xvar_sel.val()
                var yvar = $yvar_sel.val()
                var zvar = $zvar_sel.val()
                if ( $.isArray(xvar) ){ xvar = xvar[0] };
                if ( $.isArray(yvar) ){ yvar = yvar[0] };
                if ( $.isArray(zvar) ){ zvar = zvar[0] };
                
                var lat_in = $.inArray("Latitude",[xvar,yvar,zvar]) != -1
                var lon_in = $.inArray("Longitude",[xvar,yvar,zvar])  != -1
                var alt_in = $.inArray("Altitude",[xvar,yvar,zvar]) != -1
                if (debug == true) { console.log([xvar,yvar,zvar])}
                if (debug == true) { console.log([lat_in,lon_in,alt_in])}
                //$("#latinputlbl").hide()
                //$("#loninputlbl").hide()

                if (lat_in) { $("#latinputlbl").hide() } else { $("#latinputlbl").show() } 
                if (lon_in) { $("#loninputlbl").hide() } else { $("#loninputlbl").show() }
                if (alt_in) { $("#altinputlbl").hide() } else { $("#altinputlbl").show() }

                def.resolve()
                return def.promise()
            } 

            $.when_all_trigger = function(the_selector,the_event) {
                the_promises = []
                the_names = []
                $(the_selector).each(function (){
                    var the_promise = $(this).triggerHandler(the_event)
                    the_promises.push(the_promise)
                    if (debug == true) { the_names.push($(this).attr("name"))}
                })
                if (debug == true) {console.log("Waiting for "+the_names+" to trigger "+the_event)}
                return $.whenall(the_promises)
            }

            //set all var selects to their value in the controlstate
            $init_sel = function (which_sel) {
                //When we're sure we're initialized, set the option to the currently selected variable in the controlstate
                    var allset = $.Deferred()
                    var waiting_for = []

                    var xname = $xvar_sel.attr("name")
                    var yname = $yvar_sel.attr("name")
                    var zname = $zvar_sel.attr("name")
                    
                    //if (which_sel != xname && which_sel != yname && which_sel != zname && which_sel != 'all') {
                    //    throw "Invalid select to initialize"
                    //}

                    if (debug) { console.log("Initializing the variable selects: "+which_sel)}

                    if (which_sel == xname || which_sel == 'all') {
                        if (debug) { console.log("Initializing the X variable select")}
                    
                        var xvar_sel_set = $.ajax({url: "uihandler",data: {"statevar":xname},type: "GET", 
                            success: function (json) {
                                $xvar_sel.val(json[xname])
                                if (debug == true) { console.log("Init x select to "+json[xname]) }
                            },
                            error: $generic_ajax_alert  
                        })
                        waiting_for.push(xvar_sel_set)
                    }

                    if (which_sel == yname || which_sel == 'all') {
                        if (debug) { console.log("Initializing the Y variable select")}

                        var yvar_sel_set = $.ajax({url: "uihandler",data: {"statevar":yname},type: "GET", 
                            success: function (json) {
                                $yvar_sel.val(json[yname])
                                if (debug == true) { console.log("Init y select to "+json[yname]) }
                            },
                            error: $generic_ajax_alert
                        })
                        waiting_for.push(yvar_sel_set)
                    }

                    if (which_sel == zname || which_sel == 'all') {
                        if (debug) { console.log("Initializing the Z variable select")}
                    
                        var zvar_sel_set = $.ajax({url: "uihandler",data: {"statevar":zname},type: "GET", 
                            success: function (json) {
                                $zvar_sel.val(json[zname])
                                if (debug == true) { console.log("Init z select to "+json[zname]) }
                            },
                            error: $generic_ajax_alert
                        })
                        waiting_for.push(zvar_sel_set)
                    }

                    $.whenall(waiting_for).then(allset.resolve)
                    return allset.promise()
            }

            $format_caption = function (csstring) {
                //Turns a comma-seperated string into a ul
                if (debug == true) { console.log("Formatting caption") }
                var values = csstring.split('|') //split on pipes incase there are any commas in data
                var theul = '<ul ID="captionlist" class="captionlist">' 
                for (v in values) {
                    theul=theul+'<li class="captionlist">' + values[v] + '</li>'
                }
                theul=theul+'</ul>'
                //if (debug == true) { console.log("Done") }
                return theul
            }

            
            $hide_controls("Prepare for launch!")

            //-----------------------------------------------------
            //Handlers which initialize or update UI control values
            //-----------------------------------------------------

            $plottype_sel.on("focus",function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                var done = $.Deferred()
                //Use the name attr of the input to decide what field of the datetime object we will get
                
                var doneprocessing = $.ajax({url: "/uihandler",data: {"statevar":myname},type: "GET",dataType:"json",
                    success: function(json) {
                        var newval = json[myname]
                        $cblog(3,e,"Plottype from backend is: "+json[myname])
			if (newval != $(e.target).val()) {
				$(e.target).val(json[myname])
                        	$cblog(3,e,"Plottype changed to: "+newval)
				var changedtype = $plottype_sel.triggerHandler("change")
				$.when(changedtype).then(done.resolve())
				$(e.target).fadeOut(200).fadeIn(200)
			}
			
                    }
                })
                return $.when(doneprocessing).then(done)
                //e.preventDefault()
            });


            //--X,Y and Z Variable Selects 
            $all_var_sel.on("focus",function( e ) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                //Initialize it if it asks for it
                var myname = $(e.target).attr("name")
                //get what is selected so we can decide if it's sane given the new options
                var selection = $(e.target).val()
                var initializing = $.Deferred()
                $cblog(4,e,"selection is "+selection)
                if ( $(e.target).hasClass("initialize_me") ){
                    $cblog(4,e,"initializing.")
                    //Get the list of valid options we can use from the backend (from the session)
                    var spawning_options = $.ajax({url: "/uihandler",data: {"statevar":myname+"_options"},type: "GET",
                        success: function( json ) {
                            //Populate the list
                            $("option",e.target).remove(); //All options under this
                            //if (debug == true) { console.log(json) }
                            $.each(json[myname+"_options"], function(key, value) {
                                //Set the option value to the key, and the html to the value
                                $(e.target).append($('<option>', { value : key }).text(value))

                            });
                                                    
                        }
                    });
                    //Remove the initilization tag from the select
                    $(e.target).removeClass("initialize_me")
                    //Set the initializing deferred to resolved once we've 

                    //Make sure the current selection is a valid option, otherwise change it and trigger "change"
                    $.when(spawning_options).then(function () {
                        var optionValues = [];
                        $('option',e.target).each(function() {
                            optionValues.push($(this).val());
                        });
                        if ( !$.inArray(selection,optionValues) ) {
                            $cblog(2,e,"Option "+selection+" is not sane, defualting to "+optionValues[0])
                            $(e.target).val(optionValues[0])
                            return $(e.target).triggerHandler("change")
                        }
                    }).then($init_sel(myname)).then($selobj[myname]['bounds'].triggerHandler("focus")).done(initializing.resolve)
                    
                } else {
                    $.when($selobj[myname]['bounds'].triggerHandler("focus")).then(initializing.resolve())
                }
                
                return initializing.promise()
                //e.preventDefault()
            });

            //--X, Y, and Z Limit Inputs
            $all_var_bounds.on("focus",function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                var the_ajax = $.ajax({url: "/uihandler",data: {"statevar":myname},type: "GET",
                    success: function(json){
                        var newbounds = json[myname]
                        if ($.isArray(newbounds[0])) {
                            //We don't want multiple limits
                            newbounds = newbounds[newbounds.length-1]
                        }
                        var newval = $format_number(newbounds) 
                        if ($(e.target).val() != newval) {
                            $(e.target).val(newval)
                            $(e.target).fadeOut(200).fadeIn(200) 
                            $cblog(4,e,"Bounds changed to "+newval)
                        }
                        
                    }
                });
                return the_ajax
                //e.preventDefault()
            });

            //--Date Entry Inputs
            $(".dateinput").on("focus",function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                //Use the name attr of the input to decide what field of the datetime object we will get
                
                var dtpadding = {"year":4,"month":2,"day":2,"hour":2,"minute":2}

                var the_ajax = $.ajax({url: "/uihandler",data: {"statevar":"datetime","subfield":myname},type: "GET",dataType:"json",
                    success: function(json) {
                        newval = $pad(json["datetime"],dtpadding[myname])
                        if ( newval != $(e.target).val() ) {
                            $(e.target).val(newval)
                            $(e.target).fadeOut(200).fadeIn(200)
                            $cblog(4,e,"value changed to "+json["datetime"])
                        }
                        
                    }
                })
                return the_ajax
                //e.preventDefault()
            });

            //--Latitude, Longitude, Altitude Input Elements
            $(".positioninput").on("focus",function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                //Use the name attr of the input to decide what field of the datetime object we will get
                
                var the_ajax = $.ajax({url: "/uihandler",data: {"statevar":myname},type: "GET",dataType:"json",
                    success: function(json) {
                        var newval = String(json[myname])
                        if ($(e.target).val() != newval){
                            $(e.target).val(newval)
                            $(e.target).fadeOut(200).fadeIn(200)
                        }
                        $cblog(4,e,"stringified value from backend is "+newval)
                    }
                })
                return the_ajax
                //e.preventDefault()
            });

            //--Driver Entry Inputs Are Dynamically Created
            //--so must be rebound when they are created
            //--look for them bound to the main document click handler below

            

            //-------------------------------------------------------------------
            //Handlers which put new values to backend controlstate (on "change")
            //-------------------------------------------------------------------

            //--The Type of Plot Chooser Select
            $plottype_sel.on("change",function(e) {
                $cblog(5,e,"In callback")
                var selection = $(e.target).val();
                var defrd = $.Deferred() //This is so we can check if the callback finished
                //Tell the backend that we have a change to the plotvar
                //{"statevar":"plottype","newval":selection}
                $cblog(4,e,"selection is "+String(selection)) 

                var plottype_changed = $.ajax({url: "/uihandler",data: {"statevar":"plottype","newval":selection},type: "PUT"})

                if (selection == "line") {
                    //If we are plotting a line, then don"t bother showing the color variable select
                    
                    //Trigger the xvar, yvar to populate
                    
                    $xvar_sel.addClass("initialize_me")
                    $xvar_sel.attr("multiple","true")
                    $("#xlog_label").show()
                    
                    $yvar_sel.addClass("initialize_me")
                    $yvar_sel.attr("multiple","true")
                    $("#ylog_label").show()
                    
                    $(".zvar").hide();
                    $zvar_sel.removeAttr("multiple")
                }

                if (selection == "pcolor")
                {
                    $(".zvar").show()
                    
                    $xvar_sel.addClass("initialize_me")
                    $xvar_sel.removeAttr("multiple")
                    $("#xlog_label").hide()

                    
                    $yvar_sel.addClass("initialize_me")
                    $yvar_sel.removeAttr("multiple")
                    $("#ylog_label").hide()

                    $zvar_sel.addClass("initialize_me")
                    $zvar_sel.removeAttr("multiple")
                    $("#zlog_label").show()

                }

                if (selection == "map")
                {
                    $(".zvar").show()
                    
                    $xvar_sel.addClass("initialize_me")
                    $xvar_sel.removeAttr("multiple")
                    $("#xlog_label").hide()
                    
                    $yvar_sel.addClass("initialize_me")
                    $yvar_sel.removeAttr("multiple")
                    $("#ylog_label").hide()

                    $zvar_sel.addClass("initialize_me")
                    $zvar_sel.removeAttr("multiple")
                    $("#zlog_label").show()
                        
                }
                
                $all_var_log.prop("checked",false)
                
                $.when(plottype_changed).done(function (data) {
                    
                    $cblog(4,e,"triggering focus from plottype change") 
                    $.when_all_trigger($all_var_log,'change').then($.when_all_trigger($all_var_sel,"focus")).then(defrd.resolve);
                })
            
                return defrd.promise() //Return a Deferred so we can see if the callback finished
            });

            //--Model Select Dropdown
            $("#model_select").on("change",function(e) {
                $hide_controls("Changing models to: "+ $(e.target).val())
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                var selection = $(e.target).val()
                $cblog(4,e,"selection is "+String(selection)) 
                var putting_new_model = $.ajax({url: "/uihandler",data: {"statevar":myname,"newval":selection},type: "PUT",
                            success: function (ret) {
                                $("#dynamicdriverdiv").addClass("initialize_me") // Reinit drivers dropdown
                                $all_var_sel.addClass("initialize_me")
                                $cblog(3,e,"dynamic driver div told to reinit,triggering all focus") 
                                return $.when($.when_all_trigger($all_controls,"focus")).then($("#dynamicdriverdiv").triggerHandler("click")).then($init_sel('all')).then($show_controls)
                            }   
                })

                return putting_new_model
            });

            //Hide it for now because it doesn't work
            $("#model_select").hide()
            
            //--X,Y,Z Variable Select Dropdowns 
            $all_var_sel.on("change",function(e) {
                $cblog(5,e,"In callback")
                //We use the name attribute to know what controlstate variable the select sets
                var myname = $(e.target).attr("name")
                var selection = $(e.target).val()
                var statevar = String(myname.charAt(0)+"multi")
                var change_done = $.Deferred()

                //Handles formating the data for PUT ajax calls
                if ( $.isArray(selection) && selection.length > 1) {
                    $cblog(4,e,"Multiple selection is ON, and selection length is "+String(selection.length)+"selection is"+String(selection))
                    var multi_updated = $.ajax({url: "/uihandler",data: {"statevar":statevar,"newval":true},type: "PUT"})
                } else if ( $.isArray(selection) && selection.length == 1 ) {
                    $cblog(4,e,"Multiple selection is ON, but selection length is 1, selection is"+String(selection)) 
                    selection = selection[0]
                    var multi_updated = $.ajax({url: "/uihandler",data: {"statevar":statevar,"newval":false},type: "PUT"})
                    
                } else {
                    $cblog(4,e,"Multiple selection is OFF, selection is"+String(selection)) 
                    var multi_updated = $.ajax({url: "/uihandler",data: {"statevar":statevar,"newval":false},type: "PUT"}) 
                }
                
                
                //Have to do something odd to pass an array to cherrypy with jquery, use 'traditional' param parsing mode
                multi_updated.done( function(data) {
                    $cblog(4,e,"Done updating multi.") 
                    
                    var ajax_done = $.ajax({url: "/uihandler",data: $.param({"statevar":myname,"newval":selection}, true),type: "PUT"})
                    //Make sure the bounds are up to date
                    
                    $.when(ajax_done
                    ).then($selobj[myname]['sel'].triggerHandler("focus")
                    ).then($selobj[myname]['bounds'].triggerHandler("focus")
                    ).then($hidePosIfNeeded).then($.when_all_trigger(".positioninput","focus")).done(function(){
                        change_done.resolve()
                        $cblog(4,e,"Done chaining focus after updating multi.") 
                    })
                    
                });

                return change_done.promise()
                
            });

            //--X, Y and Z Log Checkboxes
            $all_var_log.on("change",function(e) {
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                var newval = $(e.target).prop("checked")
                $cblog(4,e,"checked property is: "+String(newval)) 
                return $.ajax({url: "/uihandler",data: {"statevar":myname,"newval":newval},type: "PUT"})
                
            });

            //--X, Y, and Z Bounds Inputs
            $all_var_bounds.on("change",function(e) {
                $cblog(5,e,"In callback")
                var myname = $(e.target).attr("name")
                var newval = $(e.target).val()
                var temp = newval.split(',') //Try to split up by commas
                
                $cblog(4,e,"value of textbox is: "+newval)
                $cblog(4,e,"value of split array is: "+String(temp))
                
                if ( temp.length % 2 != 0 || temp.length < 2 ) {
                    alert("Bounds inputs must have form lowerbound,upperbound,(lowerbound2,upperbound2,... if multiplot)")
                } else {
                    //Have to do something odd to pass an array to cherrypy with jquery, use 'traditional' param parsing mode
                    putting_bounds = $.ajax({url: "/uihandler",data: $.param({"statevar":myname,"newval":temp},true),type: "PUT",
                        error: function (e) {
                            alert("Unable to complete bounds update. Please make sure your bounds were formatted correctly (always include decimal point)")
                        }
                    })
                    
                    return $.when(putting_bounds).then($('#plotbutton').triggerHandler("click"))
                }
            });

            //--Date Change Inputs
            $(".dateinput").on("change",function(e) {
                $cblog(5,e,"In callback")
                //Use the name attr of the input to decide what field of the datetime object we will set
                var myname = $(e.target).attr("name")
                var newval = $(e.target).val()
                $cblog(4,e,"value is: "+newval)
                //{"statevar":"datetime","newval":{myname : parseInt(newval)}}
                var ajax_done = $.ajax({url: "/uihandler",data: {"statevar":"datetime","subfield":myname,"newval":parseInt(newval)},type: "PUT"})
                var plotting = $.when(ajax_done).then($("#plotbutton").triggerHandler("click"))
                return plotting
            });

            //--Position Change Inputs
            $(".positioninput").on("change",function(e) {
                $cblog(5,e,"In callback")
                //Use the name attr of the input to decide what field of the datetime object we will set
                var myname = $(e.target).attr("name")
                var newval = $(e.target).val()

                $cblog(4,e,"value is: "+newval)

                //{"statevar":"datetime","newval":{myname : parseInt(newval)}}
                var ajax_done = $.ajax({url: "/uihandler",data: {"statevar":myname,"newval":newval},type: "PUT"})
                var autoscale_done = $.ajax({url: "/uihandler",data: {"posttype":"autoscale"},type: "POST"})
                var plotting = $.when(ajax_done,autoscale_done).then($("#plotbutton").triggerHandler("click"))
                return plotting
            });

            
            //---Handle clicking the plot button---
            $('#plotbutton').on('click',function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                //Tell the backend to work through any UI changes and replot
                var plotting_done = $.Deferred()

                //Put in the loading sign
                $("#plotimg").attr("src","/www/loading.gif").fadeIn(200)

                var refreshing = $.ajax({url: "/uihandler", data: {"posttype":"refreshnow"},type: "POST",
                    error: function(jqxhr,status,error) {
                        
                        $cblog(1,e,"FAILED on refreshnow POST, error was "+jqxhr.responseText)
                        var getting_error = $.ajax({url: "/uihandler", data: {"statevar":"lasterror"},type: "GET",
                            success: function (json) {
                                alert("Oops, I couldn't refresh your plot. Please check that your selections make sense and press the plot button again. This message from the server may give you an idea what went wrong: "+String(json['lasterror']))
                            $("#plotimg").attr("src","/www/error.png").fadeIn(200)
                            }
                        })
                        return getting_error
                        
                    }

                })

                $.when(refreshing).then(function (thedata) {
                    //Tell the backend to save the plot and return the url to the image
                    $cblog(4,e,"refreshnow POST succeeded, now attempting to plot")
                    var done_replotting = $.ajax({url: "/uihandler", data: {"posttype":"replotnow"},type: "POST",dataType: "json",
                        success: function( json ) {
                            $cblog(4,e,"replotnow POST succeeded adding plot "+json["src"])
                            $cblog(5,e,"caption is "+json["cap"])

                            $("#plotimg").attr("src",json["src"]).fadeIn(200);    
                            $("#plotimg_cap").html($format_caption(json["cap"]))
                            $("#dynamicdriverdiv").addClass('initialize_me')
                            $driver_reinit = true
                        },
                        error : function ( jqxhr ) {
                            $cblog(1,e,"FAILED replotnow POST request text is: "+jqxhr.responseText)
                            alert("Oops, I was unable to save your plot. Please change your selections and try again.")
                            $("#plotimg").attr("src","/www/error.png").fadeIn(200)
                        }
                        
                    })
                    //Make sure position and date are up to date
                    return done_replotting
                }).then(function (f3) {
                    $cblog(4,e,"Now triggering dynamicdriverdiv click handler")
                    return $("#dynamicdriverdiv").triggerHandler("click")
                }).then($.when_all_trigger($all_controls,"focus")).done(function (f) {
                    $cblog(4,e,"done with plotting, resolving main Deferred.")
                    plotting_done.resolve()
                })
                
                return plotting_done.promise()
            });



            //Drivers inputs that are Ajaxed in
            $("#dynamicdriverdiv").on("click", function (e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                var all_done = $.Deferred()
                $cblog(4,e,"Dynamic drivers click callback. Has init class:"+String($("#dynamicdriverdiv").hasClass('initialize_me')));

                if ( $("#dynamicdriverdiv").hasClass('initialize_me') || $driver_reinit == true) {
                    //make sure the controlstate is up to date. Strictly this isn't nessecary
                    //var refreshing = $.ajax({url: "/uihandler", data: {"posttype":"refreshmodeloptions"},type: "POST"})
                    //$(".dynamicinput").remove()
                    theinputs = $(".dynamicinput")

                    
                    var getting_drivers = $.ajax({url: "/uihandler",data: {"statevar":"drivers"},type:"GET",
                        success: function(json){
                            $cblog(4,e,"Now building dynamic drivers list");
                            var bigselector = ''
                            $.each(json["drivers"], function(key,value) {
                                
                                $cblog(5,e,"Adding driver "+key+" : "+value)
                                

                                bigselector = bigselector+"#dynamicinput"+key+' '+"#dynamicinputlabel"+key+' '

                                //If we already have a field, don't overwrite it.
                                var theinput = $("#dynamicinput"+key)
                                var thelabel = $("#dynamicinputlabel"+key)
                                var thebreak = $("#dynamicinputbr"+key)

                                theinputs = theinputs.not(theinput).not(thelabel).not(thebreak)

                                if ( theinput.length==0 ) {
                                    //Dynamically determine the length of the field
                                    var field_size = String(value).length
                                    var valstr = $format_number(value)
                                    
                                    if (field_size > 15) { field_size = 15}
                                    $cblog(4,e,"Creating new input and label for "+String(key)+": "+valstr)
                                    theinput = $("<input type='text' class='dynamicinput' size="+String(field_size)+">").val(valstr).attr("name",key).attr("ID",'dynamicinput'+key)
                                    //Make a new change callback
                                    theinput.on("change",function(e){
                                        $cblog(5,e,"In callback")
                                        var myname = $(e.target).attr("name")
                                        var textval = $(e.target).val()
                                        $cblog(4,e,"new value is "+textval)
                                        var ajax_done = $.ajax({url: "/uihandler",data: {"statevar":"drivers","subfield":myname,"newval":textval},type: "PUT"})
                                        var plotting_done = $.when(ajax_done).then($("#plotbutton").triggerHandler("click"))
                                        return plotting_done
                                    });
                                    //Make a new focus callback
                                    theinput.on("focus",function(e){
                                        e.preventDefault();
                                        $cblog(5,e,"In callback")
                                        var myname = $(e.target).attr("name")
                                        var textval = $(e.target).val()
                                        $cblog(4,e,"backend value is "+textval)
                                        var ajax_done = $.ajax({url: "/uihandler",data: {"statevar":"drivers","subfield":myname},type: "GET",
                                            success: function (json) {
                                                $cblog(4,e,"value from backend is "+$format_number(json["drivers"]))
                                                $(e.target).val($format_number(json["drivers"]))
                                            }
                                        })
                                        return ajax_done
                                    });
                                    
                                    thelabel = $("<label class='dynamicinput'>").text(key+": ").attr("ID",'dynamicinputlabel'+key)
                                    $("#dynamicdriverdiv").append(thelabel.append(theinput)) 
                                    $("#dynamicdriverdiv").append($("<br class='dynamicinput'>").attr("ID",'dynamicinputbr'+key))

                                } else {
                                    //console.log(theinput.val(),value)
                                    if (theinput.val() != value) {
                                        theinput.val(value)
                                        theinput.fadeOut(200).fadeIn(200)
                                    }

                                }
                                
                                
                            }) //Loop on all the contents of the returned "drivers" object

                            //Get rid of any straggling inputs that were not in the AJAX'd json   
                            theinputs.remove()

                        } //success function
                    });
                    $("#dynamicdriverdiv").removeClass("initialize_me")
                    $driver_reinit = false

                    var getting_units = $.when(getting_drivers).then($.ajax({url: "/uihandler",data: {"statevar":"drivers_units"},type:"GET",
                        success: function(json){
                            //Put the driver units on the labels
                            $.each(json['drivers_units'],function(key,val){
                                var oldval = $("#dynamicinputlabel"+key).text()
                                if (val != null && oldval.indexOf('World') == -1) {
                                    $("#dynamicinputlabel"+key).append("<span class='dynamicinput'>["+String(val)+"]</span>")
                                }
                            })
                            
                        }
                    }));

                    $.when(getting_units).done(all_done.resolve)
                } else {
                    $cblog(4,e,"Drivers not set to reinit, resolving main Deferred")
                    all_done.resolve()
                }
                return all_done.promise()
            })

            //Put a loading image in the plot
            $("#capdiv").slideUp()
            $("#plotimg").attr("src","/www/loading.gif").fadeIn(200)
                                    
            //Signal to the uihandler that we're ready to sync up the contolstate
            //this propagates any changes that happened to the ControlState dict
            //on the backend to the CherryPy session variable 
            var synching = $.ajax({url: "/uihandler", data: {"posttype":"uiready"},type: "POST"})
            //synching is a 'Promise'...a read-only Deferred


            //--Set initial plot
            var firstplot = $.when(synching).then(function (thedata) {
                var success_done = $.Deferred()
                $logit(3,"synching.done"," uiready POST has been sent and completed")
                var plotting_done = $.ajax({url: "/uihandler", data: {"posttype":"replotnow"},type: "POST",dataType: "json",
                    success: function( json ) {
                        
                        
                        $logit(4,"syching.done: AJAX: POST:replotnow: success"," Beginning intialization $.then chain")
                        //These must be done in the right order, so they pass back a 
                        //promises so they can be used with when and then
                        //They must be done in order because they tell the x,y,and z
                        //selectors to populate and set up the proper visibility for those 
                        //elements based on the plottype that is default in the controlstate
                        
                        $.when($plottype_sel.triggerHandler("focus")
                            ).then(function (thedat) {
                                $logit(4,"syching.done: AJAX: POST:replotnow : success","Done with plottype focus")
                                return $.when($plottype_sel.triggerHandler("change"))
                            }).then(function (data) {
                                
                                $logit(4,"syching.done: AJAX: POST:replotnow : success","Done with plottype change") 
                                var xdone = $xvar_sel.triggerHandler("focus")
                                var ydone = $yvar_sel.triggerHandler("focus")
                                var zdone = $zvar_sel.triggerHandler("focus")
                                return $.when(xdone,ydone,zdone).then($.when_all_trigger('.positioninput,.dateinput',"focus"));
                            }).then(function (thedata) {
                                    $logit(4,"syching.done: AJAX: POST:replotnow : success","Now trigger bounds focus")
                                    //trigger all bounds to refresh
                                    return $.when_all_trigger($all_var_bounds,"focus")
                            }).then($("#dynamicdriverdiv").triggerHandler("click")).then(
                                function (stuff) {
                                //Very last thing we do is take away the loading gif
                                //and update the plot
                                $logit(4,"syching.done: AJAX: POST:replotnow : success","Now remove loading gif and put in img and caption")        
                                $("#plotimg").attr("src",json["src"]);    
                                $("#plotimg_cap").html($format_caption(json["cap"]))
                                $show_controls()
                                success_done.resolve()
                            })
                    }
                        
                });
                return success_done.promise() 
            });


            
            //Handle clicking the previous or next button


            $("#previous_button").on("click",function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                var prevdone = $.Deferred()
                //Put in the loading sign
                $("#plotimg").attr("src","/www/loading.gif").fadeIn(200)

                var getting_prev = $.ajax({url: "/uihandler", data: {"posttype":"prevplot"},type: "POST",
                    success: function (json) {
                        $("#plotimg").attr("src",json["plot"]).fadeIn(400);
                        $("#plotimg_cap").html($format_caption(json["caption"]));
                        
                        $cblog(4,e,"previous: img: "+json["plot"]+"ind: "+String(json["ind"])+"len(controlstatemanger.states)="+String(json["maxind"]))
                                    
                        $("#caplabel").text('Plot #'+json["ind"]+'/'+json["maxind"])
                        $("#dynamicdriverdiv").addClass('initialize_me')
                        $driver_reinit = true
                    },
                    error: function (jqxhr) {

                        $cblog(1,e,"FAILED to AJAX in previous plot url, caption, index, response was: "+jqxhr.responseText)
                        alert("Sorry, I couldn't retrieve previous plot")
                        $("#plotimg").attr("src","/www/error.png").fadeIn(200)
                    }

                });
                
                $.when(getting_prev).then(function () {
                    if (debug) {console.log("Now triggering dynamicdriverdiv click handler from prev plot callback")}
                    return $("#dynamicdriverdiv").triggerHandler("click")
                }).then($.when_all_trigger($all_controls,"focus")).then($init_sel('all')).done(function (f) {
                    $cblog(4,e,"Done with previous, resolving")
                    prevdone.resolve()
                    return prevdone.promise()
                })

                return prevdone.promise()
            })

            $("#next_button").on("click",function(e) {
                e.preventDefault();
                $cblog(5,e,"In callback")
                //Put in the loading sign
                var nextdone = $.Deferred()
                $("#plotimg").attr("src","/www/loading.gif").fadeIn(200)

                var getting_next = $.ajax({url: "/uihandler", data: {"posttype":"nextplot"},type: "POST",
                    success: function (json) {
                        $("#plotimg").attr("src",json["plot"]).fadeIn(400);
                        $("#plotimg_cap").html($format_caption(json["caption"]));
                        $("#caplabel").text('Plot #'+json["ind"]+'/'+json["maxind"])
                        $("#dynamicdriverdiv").addClass('initialize_me')
                        $driver_reinit = true

                        $cblog(4,e,"next: img: "+json["plot"]+"ind: "+String(json["ind"])+"len(controlstatemanger.states)="+String(json["maxind"]))
                    },

                    error: function (jqxhr) {
                        $cblog(1,e,"FAILED to AJAX in nextplot plot url, caption, index, response was: "+jqxhr.responseText)
                        alert("Sorry, I couldn't retrieve next plot")
                        $("#plotimg").attr("src","/www/error.png").fadeIn(200)
                    }

                });

                $.when(getting_next).then(function () {
                    if (debug) {console.log("Now triggering dynamicdriverdiv click handler from next plot callback")}
                    return $("#dynamicdriverdiv").triggerHandler("click")
                }).then($.when_all_trigger($all_controls,"focus")).then($init_sel('all')).done(function (f) {
                    $cblog(4,e,"Done with next, resolving")
                    nextdone.resolve()
                    return nextdone.promise()
                });

                return nextdone.promise()
            });
                
            
            //Some cute little animation of the plot details
            $("#plotimg").on('click', function() {

                $('#capdiv').slideToggle()
            })

            $("#capdiv").on('click', function() {
                $('#capdiv').slideUp()
            })

            //Bind a click handler to the panic button
            $("#restart").on("click",function(e) {
                e.preventDefault();
                var response = window.confirm("Really restart the backend? You will lose all your plots for this session!")
                if (response) {
                    $.ajax({url: "/uihandler", data: {"posttype":"restart"},type: "POST",
                        success: function (f) {
                          
                                window.location.reload(true)
                        }
                    })
                }
            });
                
            $("#putnewval").on("change",function(e) {
                var newstatevar = $("#putstatevar").val()
                var newvalue = $("#putnewval").val()
                var dangerous = $.ajax({url: "/uihandler", data: {"statevar":newstatevar,"newval":newvalue},type: "PUT",dataType: "json"})
                return dangerous.done($("#plotbutton").triggerHandler("click"))
            })

            //Bind a click handler to the debug panel to hide it on click, or initialize it if nessecary
            //$("#debugpanel").on('click',function(e) {
            //    $cblog(5,e,"In callback")
            //    if ( $("#debugpanel").hasClass("debug_on") ) {
            //        $("#debugpanel").removeClass("debug_on")
            //        $("#debug_table,#panic").slideUp()
            //    } else {
            //        $("#debugpanel").addClass("debug_on")
            //        $("#debug_table,#panic").slideDown()
            //    }
            //    if ( $("#debugpanel").hasClass("debug_on") ) {
            //        $.ajax({url: "/uihandler",data: {"statevar":"controlstate"},type:"GET",
            //            success: function(json) {
            //                if ( $("#debugpanel").hasClass("initialize_me") ){
            //                    $("#debugpanel").append($("<table>").attr("ID","debug_table")).addClass('debug_table')
            //                    $("#debugpanel").removeClass("initialize_me")
            //                }

            //                $(".debug_table_el").remove() //Clear old
            //                $.each(json["controlstate"],function(key,value) {
            //                    //console.log(value)
            //                    $("#debug_table").prepend(
            //                        $("<tr>").append(
            //                            $("<th>").append($("<strong>").text(key)).addClass('debug_table_el').addClass('debug'+key),
            //                            $("<td>").html($.parseHTML(value)).addClass('debug_table_el').addClass('debug'+key)
            //                        )
            //                    ).addClass('debug_table')
            //                });
            //                //Make sure all of that class adding was processed
            //                $('.debug_table_el')
            //            }
            //
            //        });
            //   } else {
            //        $("#debug_table,#panic").hide()
            //    }
            //}); 

            //Force finish of init, implement hackery
            $.when(firstplot).then($hidePosIfNeeded);
        });

        $(document).keypress(function(e) {
            console.log("keypress id = "+e.which)
            if(e.which == 68) {
                // D pressed
                $(".debug").toggle()
            }
            if(e.which == 77) {
                // M press
                $("#model_select").toggle()
            }
        });
        

//        $(document).on("click", function (e){
            //This is a hack to get the position controls to hide properly. I have no idea why it's not 
            //working with deferreds as I had hoped. Arg.
//           
//        });

    </script>
    <body>
        <div ID = "titlepanel" class="panel">
            <h1 class="h1title">Atmospheric Model Web Explorer (AtModWeb)</h1>
        </div>
        <div ID = "loading" class="panel">
            <h2 ID = "loading_message">Loading...please wait</h2>
        </div>
        <div ID="wrap">
            <div ID="leftcolumn">
                
                <div ID="locationpanel" class="panel">
                <h2 class="h2title">Location</h2>
                    <label ID='latinputlbl'>Latitude:<input ID='latinput' type="text" name="lat" size="8" value="" class="positioninput"></label><br>
                    <label ID='loninputlbl'>Longitude:<input ID='loninput' type="text" name="lon" size="8" value="" class="positioninput"></label><br>
                    <label ID='altinputlbl'>Altitude[km]:<input ID='altinput' type="text" name="alt" size="8" value="" class="positioninput"></label>
                </div>

                <div ID="datepanel" class="panel">
                    <h2 class="h2title">Date and Time</h2>
		    <p>Entering a date will also look up the drivers for that date</p>
                    <p>Y-M-D H:M</p>
                    <input type="text" name="year" value="2000" size="4" class="dateinput"><span>-</span>
                    <input type="text" name="month" value="06" size="2" class="dateinput"><span>-</span>
                    <input type="text" name="day" value="21" size="2" class="dateinput"><span>  </span>
                    <input type="text" name="hour" value="12" size="2" class="dateinput"><span>:</span>
                    <input type="text" name="minute" value="00" size="2" class="dateinput">             
                </div>
                
                
                <div ID="manualpanel" class="panel">
                    <h2 class="h2title">Manual Driver Entry</h2>
                    <div ID="dynamicdriverdiv" class="initialize_me">

                    </div>
                </div>

                <div ID="debugpanel" class="panel debug">
                    
                    <h2 class="h2title debug">Debugging</h2>
                    <label ID='setlabel' class="debug">Send PUT Request<input type="text" name="statevar" class="debug" value="mapproj" ID="putstatevar"><input type="text" name="value" class="debug" value="moll" ID="putnewval"></label>
                    <button ID="restart" class="debug">Restart Backend</button>
                </div>

            </div>
            
            <div ID="rightcolumn">
                <div ID="mainpanel" class="panel">
                    <h2 class="h2title">Plot Options</h2>
                    
                    <select ID="model_select" name="modelname" class="model">
                        <option value="msis">NRLMSISE00</option>
                        <option value="hwm">HWM07</option>
                    </select>

                    <select ID="plottype_select" name="plottype" class="plottype">
                        <option value="null">Choose a plot type...</option>
                        <option value="line">Line Plot</option>
                        <option value="pcolor">Heatmap/Pseudocolor</option>
                        <option value="map">Map</option>
                    </select>

                    <button ID="plotbutton">replot!</button>

                    <div ID="xvar_div" class="panel xvar">
                        <h2 style="display:inline;" class="var yvar">X:</h2>
                        <select ID="xvar_select" name="xvar" multiple="true" class="var xvar intitialize_me">
                                <option value="null">Choose a X variable...</option>
                        </select>

                        <label ID="xlog_label" class="xvar">Logscale X:                 
                            <input ID="xlog" type="checkbox" name="xlog" class="var xvar log">
                        </label>

                        <label ID="xbounds_label" class="xvar">X-axis Limits:                   
                            <input ID="xbounds" type="text" name="xbounds" class="var xvar bounds">
                        </label>
                    </div>
                    
                    <div ID="yvar_div" class="panel yvar">
                        <h2 style="display:inline;" class="var yvar">Y:</h2>
                        <select ID="yvar_select" name="yvar" multiple="true" class="var yvar intitialize_me">
                            <option value="null">Choose a Y variable...</option>
                        </select>
                        
                        <label ID="ylog_label" class="yvar">Logscale Y:             
                            <input ID="ylog" type="checkbox" name="ylog" class="var yvar log">
                        </label>

                        <label ID="ybounds_label" class="yvar">Y-axis Limits:                   
                            <input ID="ybounds" type="text" name="ybounds" class="var yvar bounds">
                        </label>
                    </div>
                    
                    <div ID="zvar_div" class="panel zvar">
                        <h2 style="display:inline;" class="var zvar">Z:</h2>
                        <select ID="zvar_select" name="zvar" multiple="true" class="var zvar intitialize_me">
                            <option value="null">Choose a color variable...</option>
                        </select>

                        <label ID="zvar_label" class="zvar">Logscale Z:             
                            <input ID="zlog" type="checkbox" name="zlog" class="var zvar log">
                        </label>

                        <label ID="zbounds_label" class="zvar">Z-axis Limits:                   
                            <input ID="zbounds" type="text" name="zbounds" class="var zvar bounds">
                        </label>

                    </div>

                    

                    <br>
                    <div ID="plotholder" class="plot_container">
                        <button ID="previous_button"> Previous </button>
                        <button ID="next_button"> Next </button>
                        <strong ID="caplabel">Plot Details Available (click plot to hide/show)</strong>
                        <figure ID="plotfig">
                            <img ID="plotimg" alt="My MSIS plot" src="" title="Click to show/hide plot details"></img>
                        </figure>
                        <div ID="capdiv" class="panel">
                            <figcaption ID="plotimg_cap" class="plot_cap"></figcaption>
                        </div>
                        
                    </div>
                </div>
            </div>  
        </div>
        
    </body>
    </html>
