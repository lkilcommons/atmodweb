<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>atmodweb &mdash; AtModWeb 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="AtModWeb 0.1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">AtModWeb 0.1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for atmodweb</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">cherrypy</span> <span class="c">#Python web server</span>
<span class="c">#Main imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">pdb</span><span class="o">,</span> <span class="nn">textwrap</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">socket</span> <span class="c">#to figure out our hostname</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">pp</span>

<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">cherrypy.lib</span> <span class="kn">import</span> <span class="n">auth_digest</span>
<span class="kn">from</span> <span class="nn">cherrypy._cpdispatch</span> <span class="kn">import</span> <span class="n">Dispatcher</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="c">#Dicts must be deepcopied.</span>

<span class="c">#Import the model running code</span>
<span class="kn">from</span> <span class="nn">atmodexplorer.atmodbackend</span> <span class="kn">import</span> <span class="n">ModelRunner</span><span class="p">,</span> <span class="n">MsisRun</span><span class="p">,</span> <span class="n">ModelRun</span><span class="p">,</span> <span class="n">PlotDataHandler</span>

<span class="c"># create logger </span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;atmodweb_root&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c"># create file handler which logs everything except debug messages</span>
<span class="c">#fh = logging.FileHandler(&#39;atmodweb_root_%s.log&#39; % (datetime.datetime.now().strftime(&quot;%c&quot;)))</span>
<span class="c">#fh.setLevel(logging.INFO)</span>

<span class="c"># create console handler with a lower log level</span>
<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c"># create formatter and add it to the handlers</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> - </span><span class="si">%(name)s</span><span class="s"> - </span><span class="si">%(levelname)s</span><span class="s"> - </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span>
<span class="c">#fh.setFormatter(formatter)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="c"># add the handlers to the logger</span>
<span class="c">#log.addHandler(fh)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ansicolors</span><span class="p">:</span>
	<span class="n">HEADER</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[95m&#39;</span>
	<span class="n">OKBLUE</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[94m&#39;</span>
	<span class="n">OKGREEN</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[92m&#39;</span>
	<span class="n">WARNING</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[93m&#39;</span>
	<span class="n">FAIL</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[91m&#39;</span>
	<span class="n">ENDC</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[0m&#39;</span>
	<span class="n">BOLD</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[1m&#39;</span>
	<span class="n">UNDERLINE</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[4m&#39;</span>

<div class="viewcode-block" id="ControlState"><a class="viewcode-back" href="../for_developers.html#atmodweb.ControlState">[docs]</a><span class="k">class</span> <span class="nc">ControlState</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Subclass dict to make a dictionary that handles synchronizing with the cherrypy session before getting and after setting</span>

<span class="sd">	TODO Document Controlstate</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_sync</span> <span class="o">=</span> <span class="bp">False</span> <span class="c">#Add a flag to determine whether or not we sync with the session on set/get</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
		
		<span class="nb">dict</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
		
	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span>
	
	<span class="nd">@sync.setter</span>
	<span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="n">oldval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_sync</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">oldval</span><span class="p">:</span> <span class="c">#If we&#39;ve switched to syncing</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">()</span> <span class="c">#Force an update of the session</span>
	
	<span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
			<span class="n">cherrypy</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>

	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="c">#Make sure local copy is up to date</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">value</span>

	<span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Update the session with the dictionary contents</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Now pushing controlstate contents to cherrypy.session&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Overwriting already-existing key </span><span class="si">%s</span><span class="s"> in session.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
			<span class="n">cherrypy</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>


	<span class="k">def</span> <span class="nf">sanized_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">new_val</span><span class="p">,</span><span class="n">subkey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Examines a new value that is going to be put into the controlstate to see if it passes</span>
<span class="sd">		basic sanity checks, like being the same type as the old value, and, if it&#39;s a list,</span>
<span class="sd">		having the same number of elements, or if a dict, having the same keys</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">subkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">oldval</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">olddict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
			<span class="n">oldval</span> <span class="o">=</span> <span class="n">olddict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oldval</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newval</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;At key </span><span class="si">%s</span><span class="s">, attempted to replace </span><span class="si">%s</span><span class="s"> with </span><span class="si">%s</span><span class="s">, which is not a list!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oldval</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">)))</span>
				<span class="k">return</span> <span class="bp">False</span>

	<span class="k">def</span> <span class="nf">ashtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns value at key as html to the best of it&#39;s ability</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">htmllines</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">typestr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
				<span class="c">#It&#39;s a dictionary, render it as a ul</span>
				<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;ul ID=&quot;controlstate_</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
					<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;li ID=&quot;controlstate_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;&gt; </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) &lt;/li&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">ikey</span><span class="p">]),</span><span class="n">typestr</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">ikey</span><span class="p">])))</span>
				<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;/ul&gt;&#39;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
				<span class="c">#Array or similar, render as ol</span>
				<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;ol ID=&quot;controlstate_</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">iind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
					<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;li ID=&quot;controlstate_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;&gt; </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) &lt;/li&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">iind</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">iind</span><span class="p">]),</span><span class="n">typestr</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">iind</span><span class="p">])))</span>
				<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;/ol&gt;&#39;</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c">#Render as a p</span>
				<span class="n">htmllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;p ID=&quot;controlstate_</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> &lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="n">typestr</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No such key in controlstate </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">htmllines</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">copyasdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns a copy ControlState as a normal dictionary</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">newdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
			<span class="n">item</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s">&#39;__deepcopy__&#39;</span><span class="p">):</span> <span class="c">#Make sure that we&#39;re not getting references</span>
				<span class="n">newitem</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
			<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s">&#39;__copy__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
				<span class="n">newitem</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">newitem</span> <span class="o">=</span> <span class="n">item</span>
			<span class="n">newdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">newitem</span> 

		<span class="k">return</span> <span class="n">newdict</span>	
</div>
<span class="k">class</span> <span class="nc">ControlStateManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Contains and manages controlstate objects</span>
<span class="sd">	Since controlstates and the model runs they create are intrinsically linked,</span>
<span class="sd">	this class is a &#39;peer&#39; of ModelRunner. What that means in practice is that</span>
<span class="sd">	ControlStateManager.states and ModelRunner.runs should be 1 to 1, i.e. the n-th</span>
<span class="sd">	index of ModelRunner.runs should be the model run created by the n-th index of ControlStateManager.states</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">#List of controlstates</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">default_controlstate</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;model_index&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;datetime&#39;</span><span class="p">:{</span><span class="s">&#39;year&#39;</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span><span class="s">&#39;month&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s">&#39;day&#39;</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="s">&#39;hour&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="s">&#39;minute&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span>\
			<span class="s">&#39;lat&#39;</span><span class="p">:</span><span class="mf">40.0274</span><span class="p">,</span><span class="s">&#39;lon&#39;</span><span class="p">:</span><span class="mf">105.2519</span><span class="p">,</span><span class="s">&#39;alt&#39;</span><span class="p">:</span><span class="mf">200.</span><span class="p">,</span>\
			<span class="s">&#39;plottype&#39;</span><span class="p">:</span><span class="s">&#39;map&#39;</span><span class="p">,</span>\
			<span class="s">&#39;descstr&#39;</span><span class="p">:</span><span class="s">&#39;intial plot&#39;</span><span class="p">,</span><span class="s">&#39;gif_mode&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>\
			<span class="s">&#39;xvar&#39;</span><span class="p">:</span><span class="s">&#39;Longitude&#39;</span><span class="p">,</span><span class="s">&#39;xbounds&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span><span class="mf">180.</span><span class="p">],</span><span class="s">&#39;xnpts&#39;</span><span class="p">:</span><span class="mf">50.</span><span class="p">,</span><span class="s">&#39;xlog&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;xmulti&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;xunits&#39;</span><span class="p">:</span><span class="s">&#39;deg&#39;</span><span class="p">,</span><span class="s">&#39;xdesc&#39;</span><span class="p">:</span><span class="s">&#39;Longitude&#39;</span><span class="p">,</span>\
			<span class="s">&#39;yvar&#39;</span><span class="p">:</span><span class="s">&#39;Latitude&#39;</span><span class="p">,</span><span class="s">&#39;ybounds&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span><span class="mf">90.</span><span class="p">],</span><span class="s">&#39;ynpts&#39;</span><span class="p">:</span><span class="mf">50.</span><span class="p">,</span><span class="s">&#39;ylog&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;ymulti&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;yunits&#39;</span><span class="p">:</span><span class="s">&#39;deg&#39;</span><span class="p">,</span><span class="s">&#39;ydesc&#39;</span><span class="p">:</span><span class="s">&#39;Geodetic Latitude&#39;</span><span class="p">,</span>\
			<span class="s">&#39;zvar&#39;</span><span class="p">:</span><span class="s">&#39;Temperature&#39;</span><span class="p">,</span><span class="s">&#39;zbounds&#39;</span><span class="p">:[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1000.</span><span class="p">],</span><span class="s">&#39;zlog&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;zmulti&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;zunits&#39;</span><span class="p">:</span><span class="s">&#39;K&#39;</span><span class="p">,</span><span class="s">&#39;zdesc&#39;</span><span class="p">:</span><span class="s">&#39;Atmospheric Temperature&#39;</span><span class="p">,</span>\
			<span class="s">&#39;modelname&#39;</span><span class="p">:</span><span class="s">&#39;msis&#39;</span><span class="p">,</span><span class="s">&#39;differencemode&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;controlstate_is_sane&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
			<span class="s">&#39;thisplot&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;thiscaption&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;mapproj&#39;</span><span class="p">:</span><span class="s">&#39;moll&#39;</span><span class="p">,</span>
			<span class="s">&#39;drivers&#39;</span><span class="p">:{</span><span class="s">&#39;dt&#39;</span><span class="p">:</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)},</span>
			<span class="s">&#39;drivers_units&#39;</span><span class="p">:{</span><span class="s">&#39;dt&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">},</span>
			<span class="s">&#39;drivers_ranges&#39;</span><span class="p">:{</span><span class="s">&#39;dt&#39;</span><span class="p">:[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">59</span><span class="p">)]},</span>
			<span class="s">&#39;drivers_descriptions&#39;</span><span class="p">:{</span><span class="s">&#39;dt&#39;</span><span class="p">:</span><span class="s">&#39;date and time of model run&#39;</span><span class="p">},</span>
			<span class="s">&#39;driver_lookup&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c"># Methods which are bound to certain controlstate keys, such that when those keys are changed,</span>
								  <span class="c">#the methods are called. Sort of an ad-hoc slots and signals a&#39;la QT</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">#If the Synchronizer produces an error during refresh, it will pass a message to controlstatemangager</span>
						<span class="c">#to tell it the controlstate is bad</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">special_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;lasterror&#39;</span><span class="p">]</span> <span class="c">#Keys that can be &#39;get&#39;ed or &#39;set&#39; which aren&#39;t in the current controlstate</span>
										<span class="c">#They all get some individual ControlState instance independant variable</span>
										<span class="c">#&#39;lasterror&#39; gets self.errors[-1], and is a way for the front end to get an</span>
										<span class="c">#error message that was created with self.error</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n_max_states</span> <span class="o">=</span> <span class="mf">10.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n_total_states</span> <span class="o">=</span> <span class="mf">0.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lastind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

		<span class="c">#Add our first controlstate</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">set_default_state</span><span class="p">()</span>


	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">lastind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lastind</span>

	<span class="nd">@lastind.setter</span>
	<span class="k">def</span> <span class="nf">lastind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Attempted to set control state history index to </span><span class="si">%s</span><span class="s">, Only negative indicies allowed!&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">))</span>
			<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		<span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Attempted to set control state history index to </span><span class="si">%s</span><span class="s">, but only </span><span class="si">%s</span><span class="s"> plots in history!&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">))))</span>
			<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lastind</span> <span class="o">=</span> <span class="n">value</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastind</span><span class="p">)</span> <span class="c">#Restore that controlstate</span>
		
	<span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Make sure we can use &#39;in&#39; with this, by passing all in calls through to the current controlstate, or,</span>
<span class="sd">		if it&#39;s an exception key which has special behaviour when used in getting and setting, it will be in self.special_keys&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_keys</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">True</span> <span class="c">#TODO - Check if this is right...shouldn&#39;t this be key in self.controlstate?</span>

	<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c">#If we&#39;ve gotten here, it&#39;s because we successfully refreshed, so this is an okay set of controlstate settings</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;controlstate_is_sane&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lastind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># Fix it so that the previous and next are always referenced to the plot that is displaying (i.e</span>
			<span class="c">#If we&#39;ve gotten here then we&#39;ve just plotted something, and this controlstate is getting appended to self.states,</span>
			<span class="c">#so the previous plot should be at -2, one before this one)</span>
		
		<span class="c">#Add to the history on call</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">n_total_states</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Now adding controlstate </span><span class="si">%d</span><span class="s"> to history.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_total_states</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;--Drivers dictionary is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">])))</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">changeddict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">changeddict</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;--Key </span><span class="si">%s</span><span class="s"> changed from self.states[-1]</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">to current</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">copyasdict</span><span class="p">())</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">n_max_states</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s">&quot;Exceeded total number of stored controlstates </span><span class="si">%d</span><span class="s">. Removed </span><span class="si">%d</span><span class="s">th controlstate.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_max_states</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_total_states</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Setting on the ControlStateManager sets on the current ControlState and triggers bound methods&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_keys</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ControlStateManager TRIGGERING BOUND METHOD </span><span class="si">%s</span><span class="s"> of key </span><span class="si">%s</span><span class="s"> new value </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meth</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
				<span class="n">meth</span><span class="p">()</span>
		
	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Getting on the ControlStateManager gets on the current ControlState, unless the key is &#39;lasterror&#39; in which case it gets the last bad controlstate&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_keys</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;lasterror&#39;</span><span class="p">:</span> <span class="c">#Extra behaviors</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Returning error </span><span class="si">%s</span><span class="s"> to controlstate caller&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="s">&quot;No Error&quot;</span>
		
	<span class="k">def</span> <span class="nf">set_default_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c"># change the working ControlState to the default one  </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="o">=</span> <span class="n">ControlState</span><span class="p">()</span> <span class="c"># Overwrite anything already there</span>
		<span class="c">#Fill up the controlstate instance</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Overwriting working controlstate with default values.&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_controlstate</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>	
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="bp">True</span>

	<span class="k">def</span> <span class="nf">changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Is the current value assigned to key changed since last updatelast call?</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
					<span class="n">ch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="k">return</span> <span class="n">ch</span>
		<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
			
			<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
				<span class="c">#Typecheck</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]):</span>
						<span class="k">return</span> <span class="bp">False</span>
				<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="nb">dict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">],</span><span class="nb">dict</span><span class="p">):</span>
					<span class="k">return</span> <span class="bp">False</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">oldeqnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> 
				<span class="k">except</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to compare this controlstate key </span><span class="si">%s</span><span class="s"> with last, because compare statement errored&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;self.states[-1][</span><span class="si">%s</span><span class="s">]=i</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">self.controlstate[</span><span class="si">%s</span><span class="s">]=</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]),</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
					<span class="k">return</span> <span class="bp">False</span>	
				<span class="k">return</span> <span class="n">oldeqnew</span> 
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Key </span><span class="si">%s</span><span class="s"> not in controlstate memory</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
				<span class="k">return</span> <span class="bp">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;No historical controlstates are available (key </span><span class="si">%s</span><span class="s">) </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
			<span class="k">return</span> <span class="bp">True</span>


	<span class="k">def</span> <span class="nf">bind_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">meth</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Binds a method with no inputs to call when the controlstate item corresponding to key is called</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Method </span><span class="si">%s</span><span class="s"> added to bound methods for key </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meth</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">meth</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Key </span><span class="si">%s</span><span class="s"> got it&#39;s first bound method </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">meth</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">trigger_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Triggers a bound on changed method corresponding to key</span>
<span class="sd">		Allows specification of keyword arguments (as oppssed to setting the value, which doens&#39;t)</span>
<span class="sd">		Specifically this gets used when setting subelements of dictionarys in this dictionary</span>
<span class="sd">		because that doesn&#39;t trigger a &#39;__set__&#39;</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;MANUALLY triggering bound methods for key </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bound_meth</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
			<span class="n">meth</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>	

	<span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ind</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Copies all values from controlstate at states[ind] to current controlstate&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Restoring controlstate from history at index[</span><span class="si">%d</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ind</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ind</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">key</span><span class="p">]:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;--On restore: differing values:</span><span class="se">\n</span><span class="s">--current controlstate </span><span class="si">%s</span><span class="s"> value:</span><span class="se">\n</span><span class="s"> ---</span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s"> with self.states[</span><span class="si">%s</span><span class="s">][</span><span class="si">%s</span><span class="s">], value:</span><span class="se">\n</span><span class="s"> ---</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span>
					<span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
			<span class="k">except</span><span class="p">:</span> <span class="c">#This should not be a breaking error</span>
				<span class="k">pass</span> 

	<span class="k">def</span> <span class="nf">restore_last_good</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tries to find a model run with model_run_success = True and then restores those settings</span>
<span class="sd">		to the current controlstate.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="n">tobedeleted</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)):</span>
			<span class="c">#Work backwards</span>
			<span class="n">ind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s">&#39;controlstate_is_sane&#39;</span><span class="p">]:</span>
				<span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Restoring last controlstate from history for which model run succeeded. Index </span><span class="si">%d</span><span class="s"> is known good&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ind</span><span class="p">))</span>
				<span class="k">break</span>
		<span class="c">#	else:</span>
		<span class="c">#		tobedeleted.append(ind)</span>
		<span class="c">#		self.log.info(&quot;Controlstate at index %d was unsuccessful in running model and will be removed from the history&quot; % (ind) )</span>

		<span class="c">#for ind in tobedeleted:</span>
		<span class="c">#	del self.states[ind]</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set_default_state</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">roll_back</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;This method is called when we want to throw an error back to the front end because something in the control state is incorrect,</span>
<span class="sd">		or badly formatted. Stores a custom error message which can be recalled with a GET from the UiHandler/Frontend. The</span>
<span class="sd">		roll_back keyword argument, when true, will restore the controlstate to the last known good value&quot;&quot;&quot;</span>

		<span class="c">#If we got here, the controlstate settings are bad. We will set the appropriate flag</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;controlstate_is_sane&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span>

		<span class="c">#Add the message to the errors list</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">roll_back</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">restore_last_good</span><span class="p">()</span>

<div class="viewcode-block" id="Synchronizer"><a class="viewcode-back" href="../for_developers.html#atmodweb.Synchronizer">[docs]</a><span class="k">class</span> <span class="nc">Synchronizer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Reacts to UiHandler PUT changes in the controlstate via the bound methods</span>
<span class="sd">	Also has methods which are called by UiHandler POST</span>
<span class="sd">	Prepares Model Runs and Refreshes the FakeCanvas figure via PlotDataHandler</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">canvas</span><span class="p">,</span><span class="n">uihand</span><span class="p">):</span>
		<span class="c">#mr is the ModelRunner instance</span>
		<span class="c">#csm is the ControlStateManager instance </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="bp">None</span> <span class="c">#Placeholder for ModelRunner instance</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span> <span class="c">#The FakeCanvas instance we will plot on</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uihand</span> <span class="o">=</span> <span class="n">uihand</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">uihand</span><span class="o">.</span><span class="n">controlstate</span> <span class="c">#The UI Handler has to spin up the controlstate b</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span> <span class="o">=</span> <span class="n">PlotDataHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="n">controlstate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">)</span> <span class="c">#PDH needs canvas, obviously since it needs to plot</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">initModelRunner</span><span class="p">()</span>
		
		<span class="c">#Bind on changed methods</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Binding execute on change controlstate methods&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;plottype&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">refreshSelectOptions</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;xbounds&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xbounds_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;ybounds&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ybounds_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;xvar&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xvar_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;yvar&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">yvar_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;zvar&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">zvar_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;datetime&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;drivers&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;mapproj&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mapproj_changed</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">bind_changed</span><span class="p">(</span><span class="s">&#39;modelname&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">modelname_changed</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">initModelRunner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Does a first run of the model specified in the controlstate to make sure that there&#39;s a reference run. </span>
<span class="sd">		A lot of code looks to the previously run model (i.e. to populate the selects for x, y and z)&quot;&quot;&quot;</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span> <span class="o">=</span> <span class="n">ModelRunner</span><span class="p">(</span><span class="n">firstmodel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;modelname&#39;</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c">#Don&#39;t create a new modelrunner if we changed models, just </span>
			<span class="c">#use the same one...a heterogeneous collection of ModelRun</span>
			<span class="c">#objects in mr.runs doens&#39;t really matter much unless</span>
			<span class="c">#we&#39;re trying to use peering, which AtModWeb doesn&#39;t</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;modelname&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">init_nextrun</span><span class="p">()</span>

		<span class="c">#Make sure the default selection is sane and set the appropriate things in the next model run instance</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prepare_model_run</span><span class="p">()</span>

		<span class="c">#Now run the model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">populate</span><span class="p">()</span>
		<span class="c">#Append the model run to the runs database</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">()</span>
		
	<span class="k">def</span> <span class="nf">refreshModelRunOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;To be called whenever a new model run is instantiated. Updates all controlstate options which change with model run&quot;&quot;&quot;</span>
		<span class="c">#Update the drivers dictionary in</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;refreshModelRunOptions called...copying drivers dictionary and clearing plot data handler data&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">clear_data</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">copyasdict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">],</span><span class="n">key</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers_units&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers_ranges&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">allowed_range</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers_descriptions&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">descriptions</span><span class="p">)</span>
		

	<span class="k">def</span> <span class="nf">autoscale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Updates the xbounds,ybounds and zbounds in the controlstate from the lims dictionary in last model run&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale_all_lims</span><span class="p">()</span> <span class="c">#Sets all lims to their min and max in the model data</span>

		<span class="n">xdata</span><span class="p">,</span><span class="n">xlims</span><span class="p">,</span><span class="n">xunits</span><span class="p">,</span><span class="n">xdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims</span>
		<span class="n">ydata</span><span class="p">,</span><span class="n">ylims</span><span class="p">,</span><span class="n">yunits</span><span class="p">,</span><span class="n">ydesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims</span>
		<span class="n">zdata</span><span class="p">,</span><span class="n">zlims</span><span class="p">,</span><span class="n">zunits</span><span class="p">,</span><span class="n">zdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">xlims</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ylims</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zbounds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">zlims</span>

	<span class="k">def</span> <span class="nf">drivers_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;On changed to controlstate[&#39;drivers&#39;], update the next model run drivers&quot;&quot;&quot;</span>
		<span class="c">#Currently done in referesh?</span>
		<span class="k">if</span> <span class="n">subfield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="c">#Nothing calls this without a subfield right now</span>
			<span class="c">#Do Nothing</span>
			<span class="k">pass</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">old_driver_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="n">subfield</span><span class="p">])</span> <span class="k">if</span> <span class="n">subfield</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">drivers</span> <span class="k">else</span> <span class="s">&quot;no previous value&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;drivers_changed: next model run driver </span><span class="si">%s</span><span class="s"> changed from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subfield</span><span class="p">,</span><span class="n">old_driver_val</span><span class="p">,</span>
				<span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="n">subfield</span><span class="p">])))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="n">subfield</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="n">subfield</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">subfield</span> <span class="o">==</span> <span class="s">&#39;dt&#39;</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">]:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="s">&#39;dt&#39;</span><span class="p">],</span><span class="n">f</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">datetime_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Process a change in controlstate[&#39;datetime&#39;] dict by setting controlstate[&#39;drivers&#39;][&#39;dt&#39;]&quot;&quot;&quot;</span>
		<span class="c">#Needs subfield kwarg</span>
		<span class="c">#Convert the dict to an actual datetime</span>
		<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="s">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
		<span class="c">#Have to explicitly trigger changed since we aren&#39;t explicitly </span>
		<span class="c">#setting controlstate[&#39;drivers&#39;] TODO find a better way</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">trigger_changed</span><span class="p">(</span><span class="s">&#39;drivers&#39;</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="s">&#39;dt&#39;</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="nf">xvar_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Updates the xbounds in the controlstate when a new xvar is selected&quot;&quot;&quot;</span>
		<span class="n">xdata</span><span class="p">,</span><span class="n">xlims</span><span class="p">,</span><span class="n">xunits</span><span class="p">,</span><span class="n">xdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims, works for multi</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">xlims</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xunits&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">xunits</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xdesc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">xdesc</span>

	<span class="k">def</span> <span class="nf">yvar_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Updates the ybounds in the controlstate when a new yvar is selected&quot;&quot;&quot;</span>
		<span class="n">ydata</span><span class="p">,</span><span class="n">ylims</span><span class="p">,</span><span class="n">yunits</span><span class="p">,</span><span class="n">ydesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims, works for multi</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ylims</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yunits&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">yunits</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ydesc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ydesc</span>

	<span class="k">def</span> <span class="nf">zvar_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Updates the zbounds in the controlstate when a new zvar is selected&quot;&quot;&quot;</span>
		<span class="n">zdata</span><span class="p">,</span><span class="n">zlims</span><span class="p">,</span><span class="n">zunits</span><span class="p">,</span><span class="n">zdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims, works for multi</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zbounds&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">zlims</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zunits&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">zunits</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zdesc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">zdesc</span>

	<span class="k">def</span> <span class="nf">xbounds_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Function which is called whenever the xbounds are changed in the controlstate. Changes limits for next model run&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">):</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
			<span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">])</span>
			<span class="n">newlst</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
				<span class="n">newlst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlst</span>

	<span class="k">def</span> <span class="nf">ybounds_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Function which is called whenever the ybounds are changed in the controlstate. Changes limits for next model run&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
			<span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">])</span>
			<span class="n">newlst</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="p">):</span>
				<span class="n">newlst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">])</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newlst</span>
			
	<span class="k">def</span> <span class="nf">mapproj_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Map projection type changed&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;mapproj&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">supported_projections</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">mapproj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;mapproj&#39;</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">modelname_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Model name is changed, big reinit&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;modelname&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;msis&#39;</span><span class="p">,</span><span class="s">&#39;iri&#39;</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">initModelRunner</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">refreshSelectOptions</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">refreshModelRunOptions</span><span class="p">()</span>

	<span class="c">#Set what we are allowed to plot</span>
	<span class="k">def</span> <span class="nf">refreshSelectOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates the (x,y,z)var_options JSON-style dictionaries used to populate the variable select elements. </span>
<span class="sd">		Relies on the PlotDataHandler plot properies settings to figure out what are allowed variables</span>
<span class="sd">		for x, y and z axes for a particular type of plot (i.e. a &#39;map&#39; type plot can only have &#39;Longitude&#39; as &#39;xvar&#39;</span>
<span class="sd">		&#39;Latitude&#39; as &#39;yvar&#39; and anything as &#39;zvar&#39;).</span>
<span class="sd">		Get the current plottype from the controlstate, instead of using the PlotDataHandler setting, because</span>
<span class="sd">		the plotDataHandler setting is only updated when the &#39;refresh&#39; method is called, and front end needs to know</span>
<span class="sd">		what the available variables are to populate the HTML select element for picking variables.</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">allowed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="n">allowed</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotProperty</span><span class="p">(</span><span class="s">&#39;x_allowed&#39;</span><span class="p">)</span>
		<span class="n">allowed</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotProperty</span><span class="p">(</span><span class="s">&#39;y_allowed&#39;</span><span class="p">)</span>
		<span class="n">allowed</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotProperty</span><span class="p">(</span><span class="s">&#39;z_allowed&#39;</span><span class="p">)</span>

		<span class="n">all_options_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vars</span><span class="p">:</span>
			<span class="n">all_options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">k</span>

		<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]:</span>
			<span class="n">options_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="c">#Short circuting options</span>
			<span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
				<span class="n">options_dict</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">all_options_dict</span><span class="p">)</span>	
			<span class="k">elif</span> <span class="s">&#39;none&#39;</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
				<span class="k">pass</span> <span class="c">#Return an empty</span>
			<span class="c">#Iterate through list of allowed values</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
					<span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&#39;position&#39;</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_options_dict</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">all_options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="p">:</span> <span class="c">#Only position (input) variables are in a run before execution </span>
								<span class="n">options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
					<span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&#39;notposition&#39;</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_options_dict</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">all_options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="p">:</span> <span class="c">#Only position (input) variables are in a run before execution </span>
								<span class="n">options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_options_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
					<span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">all_options_dict</span><span class="p">:</span>
						<span class="n">options_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">var</span><span class="o">+</span><span class="s">&#39;var_options&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">options_dict</span>

		
	<span class="k">def</span> <span class="nf">plotProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prop</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Simple convenience function to retrieve a property of the current type of plot&quot;&quot;&quot;</span>
		<span class="c">#Current plottype</span>
		<span class="n">cpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;plottype&#39;</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottypes</span><span class="p">[</span><span class="n">cpt</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">is_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coord</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Convenience function for testing whether the currently selected x or y variables (controlstate[&#39;xvar&#39;],etc) are multiple vars</span>
<span class="sd">		i.e. stored as lists internally.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s">&#39;var&#39;</span><span class="p">],</span><span class="s">&#39;__iter__&#39;</span><span class="p">)</span> <span class="c">#just tests if the controlstate is a list/tuple</span>
			
	<span class="k">def</span> <span class="nf">is_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coord</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Convenience function for testing whether the currently selected x or y variables are positions. </span>
<span class="sd">		i.e do they have names &#39;Latitude&#39;,&#39;Longitude&#39; or &#39;Altitude&#39;. </span>
<span class="sd">		Handles the possibility of the variables being multiple variables on the same axes, so this is</span>
<span class="sd">		preferred way of checking instead of </span>
<span class="sd">		</span>
<span class="sd">		.. code-block :: &lt;python&gt;</span>
<span class="sd">			self.controlstate[&#39;xvar&#39;] in [&#39;Latitude&#39;,&#39;Longitude&#39;,&#39;Altitude&#39;] </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s">&#39;var&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s">&#39;var&#39;</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">prepare_model_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Determines which position variables (lat,lon, or alt) are constant,</span>
<span class="sd">		given the current settings of the xvar, yvar and zvar.</span>
<span class="sd">		</span>
<span class="sd">		Tells the ModelRun instance that is about to be populated with data,</span>
<span class="sd">		i.e. the model is going to run, what shape that data will be. </span>

<span class="sd">		If it&#39;s a line we are plotting we only need 1-d data in the model and can save some time, </span>
<span class="sd">		but if we will be plotting a pcolor or map, we&#39;ll need 2-d data. </span>
<span class="sd">		</span>
<span class="sd">		Also tells that ModelRun which position variables will be constant,</span>
<span class="sd">		and which independant: i.e. if we are plotting a &#39;Temperature&#39;</span>
<span class="sd">		vs. &#39;Altitude&#39; plot, then we want to determine which latitude</span>
<span class="sd">		and longitude values the user wants the model to calculate the altitude profile</span>
<span class="sd">		for from the controlstate (and lat and lon will be constant for the model run).</span>

<span class="sd">		&quot;&quot;&quot;</span>
	
		<span class="c">#Begin by assigning all of the position variables their approprate output</span>
		<span class="c">#from the controls structure. These are all single (scalar) values set by</span>
		<span class="c">#the frontend HTML elements for Lat, Lon and Alt.</span>
		<span class="c">#Everything is GEODETIC, not GEOCENTRIC, because that&#39;s what MSIS expects.</span>
		<span class="c">#Some of these position variables will be ignored</span>
		<span class="c">#since one must be on a plot axes if line plot,</span>
		<span class="c">#or two if a colored plot (pcolor or map)</span>
		<span class="c">#These values will be the values for their associated</span>
		<span class="c">#position variable if it is not one of the axes of the plot </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="s">&#39;Latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;lat&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="s">&#39;Longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;lon&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="s">&#39;Altitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;alt&#39;</span><span class="p">]</span>

		<span class="c">#Handle the case of two variables being set to the same thing:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;X and Y both are </span><span class="si">%s</span><span class="s">, cannot make sensible plot!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]))</span>
		
		<span class="c">#Make sure all position variables have their limits set correctly</span>
		<span class="c">#before model run so that we end up with the right generated </span>
		<span class="c">#grid </span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">):</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]</span>

		<span class="c">#Copy out the drivers from the controlstate (only copy those that are exposed via the model&#39;s __init__)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="s">&#39;dt&#39;</span><span class="p">]</span>

		<span class="c">#Now we determine from the plottype if we need to grid x and y</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotProperty</span><span class="p">(</span><span class="s">&#39;gridxy&#39;</span><span class="p">):</span>
			<span class="c">#Fault checks</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">):</span> <span class="c">#vars dict starts only with position and time</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;xvar </span><span class="si">%s</span><span class="s"> is not a valid position variable!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c">#self.mr.nextrun.lims[self.controlstate[&#39;xvar&#39;]] = self.controlstate[&#39;xbounds&#39;]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">npts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xnpts&#39;</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">set_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">])</span>

			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;yvar </span><span class="si">%s</span><span class="s"> is not a valid position variable!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c">#self.mr.nextrun.lims[self.controlstate[&#39;yvar&#39;]] = self.controlstate[&#39;ybounds&#39;]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">npts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ynpts&#39;</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">])</span>
			
		<span class="k">else</span><span class="p">:</span> <span class="c">#We do not need to grid data</span>
			<span class="c">#Check that at least one selected variable is a location</span>
			<span class="c">#Handle multiple variables on an axis</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Multiple plotting of position variables is not allowed!&#39;</span><span class="p">)</span>

			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Multiple plotting of position variables is not allowed!&#39;</span><span class="p">)</span>
				
			<span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s"> are both not valid position variables!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">])))</span>
			
			<span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">):</span> <span class="c">#It&#39;s scalar, so check if it&#39;s a position</span>
				<span class="c">#self.mr.nextrun.lims[self.controlstate[&#39;xvar&#39;]] = self.controlstate[&#39;xbounds&#39;]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">npts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xnpts&#39;</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">set_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">])</span>

			<span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_multi</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span> <span class="c">#It&#39;s scalar, so check if it&#39;s a position</span>
				<span class="c">#self.mr.nextrun.lims[self.controlstate[&#39;yvar&#39;]] = self.controlstate[&#39;ybounds&#39;]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">npts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ynpts&#39;</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Nonsensical variables: xvar:</span><span class="si">%s</span><span class="se">\n</span><span class="s"> yvar:</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]),</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">])))</span>

	<span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">force_full_refresh</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force_autoscale</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Redraws what is on the plot. Trigged on &#39;refreshnow&#39; POST request.</span>
<span class="sd">		This is the big method of this class. </span>

<span class="sd">		The basic outline is that check what controlstate values have changed</span>
<span class="sd">		since the last time it was called, and determines based on that</span>
<span class="sd">		how to tell the PlotDataHandler how to plot the user&#39;s desired image.</span>

<span class="sd">		Does not neccessarily create a new model run. Tries to determine if</span>
<span class="sd">		one is needed by the controlstate differences since last referesh.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ffr</span> <span class="o">=</span> <span class="n">force_full_refresh</span>
		<span class="n">fauto</span> <span class="o">=</span> <span class="n">force_autoscale</span>		

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;plottype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;pcolor&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&quot;xvar&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&quot;yvar&quot;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;We are plotting a pcolor type plot, and x or y was changed, so we will need to re-run the model, since what is held constant has changed&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;plottype&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="c">#Determine if we need to rerun the model</span>
			<span class="n">oldplottype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottypes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottype</span><span class="p">]</span>
			<span class="n">newplottype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottypes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;plottype&#39;</span><span class="p">]]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Plottype was changed since last refresh, from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldplottype</span><span class="p">,</span><span class="n">newplottype</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">oldplottype</span><span class="p">[</span><span class="s">&#39;gridxy&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">newplottype</span><span class="p">[</span><span class="s">&#39;gridxy&#39;</span><span class="p">]:</span> <span class="c">#we are going from vectors to grids or visa-versa</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span> <span class="c">#Must force re-run</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;This change requires a </span><span class="si">%s</span><span class="s"> re-run, since gridding scheme has changed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;modelname&#39;</span><span class="p">]))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;plottype&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">refreshSelectOptions</span><span class="p">()</span>
			
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;datetime&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;drivers&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="c">#Force model rerun</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">])</span>

			<span class="k">except</span><span class="p">:</span>
				<span class="c">#Capture the error for retrieval by the frontend failure callback</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Badly formed time! Calling controlstate error function&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span> <span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Badly formed time!: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">restore_last_good</span><span class="p">()</span>
				<span class="k">raise</span> <span class="c">#continue erroring</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Datetime was changed since last refresh. Will rerun </span><span class="si">%s</span><span class="s"> with datetime </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;modelname&#39;</span><span class="p">],</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="s">&#39;dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%c</span><span class="s">&#39;</span><span class="p">)))</span>


		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;lat&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="k">if</span> <span class="s">&#39;Latitude&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Now holding Latiude constant&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">hold_constant</span><span class="p">(</span><span class="s">&#39;Latitude&#39;</span><span class="p">)</span>
				<span class="c">#We are holding latitude constant, so we will have to rerun the model</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
		
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;lon&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="k">if</span> <span class="s">&#39;Longitude&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Now holding Longitude constant&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">hold_constant</span><span class="p">(</span><span class="s">&#39;Longitude&#39;</span><span class="p">)</span>
				<span class="c">#We are holding longitude constant, so we will have to rerun the model</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;alt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="k">if</span> <span class="s">&#39;Altitude&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Now holding Altitude constant&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">hold_constant</span><span class="p">(</span><span class="s">&#39;Altitude&#39;</span><span class="p">)</span>
				<span class="c">#We are holding altitude constant, so we will have to rerun the model</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
		
		<span class="c">#If the altitude boundaries were changed</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;Altitude&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;xbounds&#39;</span><span class="p">))</span> <span class="ow">or</span>\
			<span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;Altitude&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;ybounds&#39;</span><span class="p">)):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Altitude boundaries changed and altitude is X or Y variable, will rerun model&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;differencemode&#39;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

		<span class="c">#---------------------------------------------------------------------------------------------------------------------------------------</span>
		<span class="c">#Actually prepare for a new run of the model</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Now preparing next model run, because controlstate variable run_model_on_refresh==True&quot;</span><span class="p">)</span>
	
			<span class="k">try</span><span class="p">:</span> <span class="c">#Attempt to run the model</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">prepare_model_run</span><span class="p">()</span>
			<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c">#Prepare model run can throw quite a few possible runtime errors based on incorrect variables selection</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Model preperation FAILED. Calling controlstate error function&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span> <span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Prep for model call FAILED: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
				<span class="c">#Continue erroring</span>
				<span class="k">raise</span> 

			<span class="c">#If we succeeded in preparing the model try to actually run it</span>
			<span class="k">try</span><span class="p">:</span>	
				<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">nextrun</span><span class="o">.</span><span class="n">populate</span><span class="p">()</span> <span class="c">#Trigger next model run</span>
			<span class="k">except</span><span class="p">:</span>
				<span class="c">#Capture the error for retrieval by the frontend failure callback</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Model call FAILED. Calling controlstate error function&quot;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span> <span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Model Call FAILED: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">restore_last_good</span><span class="p">()</span>

				<span class="c">#Continue erroring</span>
				<span class="k">raise</span> 

			<span class="c">#Then maybe we will want to not look up drivers and just keep using the same ones</span>
			<span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;driver_lookup&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">(</span><span class="n">propagate_drivers</span><span class="o">=</span><span class="n">propagate</span><span class="p">)</span> <span class="c">#Trigger storing just created model run as mr.runs[-1]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">refreshModelRunOptions</span><span class="p">()</span> <span class="c">#Reset the plotDataHandler, make sure all controlstate options that change with model run are set</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">refreshSelectOptions</span><span class="p">()</span>
			
		<span class="c">#---------------------------------------------------------------------------------------------------------------------------------------</span>

		<span class="k">if</span> <span class="n">fauto</span><span class="p">:</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Autoscaling because forced&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale_all_lims</span><span class="p">()</span>
			
		<span class="c">#Always grab the most current data	</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Now getting data for X=</span><span class="si">%s</span><span class="s"> Y=</span><span class="si">%s</span><span class="s"> and Z=</span><span class="si">%s</span><span class="s"> via ModelRunner __getitem__&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">],</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zvar&#39;</span><span class="p">]))</span>
		<span class="n">latlims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="s">&#39;Latitude&#39;</span><span class="p">]</span>
		<span class="n">lonlims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="s">&#39;Longitude&#39;</span><span class="p">]</span>
		<span class="n">altlims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">lims</span><span class="p">[</span><span class="s">&#39;Altitude&#39;</span><span class="p">]</span>
		<span class="n">xdata</span><span class="p">,</span><span class="n">xlims</span><span class="p">,</span><span class="n">xunits</span><span class="p">,</span><span class="n">xdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims, correctly handles list xvar</span>
		<span class="n">ydata</span><span class="p">,</span><span class="n">ylims</span><span class="p">,</span><span class="n">yunits</span><span class="p">,</span><span class="n">ydesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims, correctly handles list yvar</span>
		<span class="n">zdata</span><span class="p">,</span><span class="n">zlims</span><span class="p">,</span><span class="n">zunits</span><span class="p">,</span><span class="n">zdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zvar&#39;</span><span class="p">]]</span> <span class="c">#returns data,lims, correctly handles list zvar</span>
		
		<span class="c">#Reset the bounds, multiplotting and turn of log scaling if we have changed any variables or switched on or off of difference mode</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;xvar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;yvar&#39;</span><span class="p">)</span> <span class="ow">or</span> \
			 <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;zvar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;differencemode&#39;</span><span class="p">)</span> <span class="ow">or</span> \
			 <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;alt&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;lat&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;lon&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;A variable or position was changed since last refresh&quot;</span><span class="p">)</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xlims</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ylims</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zbounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zlims</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xunits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xunits</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yunits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yunits</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zunits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zunits</span>
			
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xdesc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xdesc</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ydesc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydesc</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zdesc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zdesc</span>


		<span class="c">#Associate data in the data handler based on what variables are desired</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;modelname&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;xvar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;xbounds&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;xlog&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span> 
			<span class="n">xname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xvar&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Associating x variable </span><span class="si">%s</span><span class="s"> with plot data handler bounds </span><span class="si">%s</span><span class="s">, log </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xname</span><span class="p">),</span>
							<span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xlog&#39;</span><span class="p">])))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">associate_data</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">xdata</span><span class="p">,</span><span class="n">xname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xbounds&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xlog&#39;</span><span class="p">],</span>
				<span class="n">multi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;xmulti&#39;</span><span class="p">],</span><span class="n">units</span><span class="o">=</span><span class="n">xunits</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="n">xdesc</span><span class="p">)</span>
			
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;modelname&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;yvar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;ybounds&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;ylog&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span> 
			<span class="n">yname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;yvar&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Associating y variable </span><span class="si">%s</span><span class="s"> with plot data handler bounds </span><span class="si">%s</span><span class="s">, log </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yname</span><span class="p">),</span>
							<span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ylog&#39;</span><span class="p">])))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">associate_data</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="n">ydata</span><span class="p">,</span><span class="n">yname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ybounds&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ylog&#39;</span><span class="p">],</span>
				<span class="n">multi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;ymulti&#39;</span><span class="p">],</span><span class="n">units</span><span class="o">=</span><span class="n">yunits</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="n">ydesc</span><span class="p">)</span>
			
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;modelname&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;zvar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;zbounds&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="s">&#39;zlog&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ffr</span><span class="p">:</span>
			<span class="n">zname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zvar&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Associating z variable </span><span class="si">%s</span><span class="s"> with plot data handler bounds </span><span class="si">%s</span><span class="s">, log </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zname</span><span class="p">),</span>
							<span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zbounds&#39;</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zlog&#39;</span><span class="p">])))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">associate_data</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="n">zdata</span><span class="p">,</span><span class="n">zname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zbounds&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;zlog&#39;</span><span class="p">],</span><span class="n">units</span><span class="o">=</span><span class="n">zunits</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="n">zdesc</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;descstr&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_descstr</span><span class="p">()</span>

		<span class="c">#Actually make the plot</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>	
		<span class="k">except</span><span class="p">:</span> 
			<span class="c">#Capture the error for retrieval by the frontend failure callback</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;PlotDataHandler Plotting FAILED. Calling controlstate error function&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span> <span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Data plotting FAILED: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()))</span>
			<span class="c">#Continue erroring</span>
			<span class="k">raise</span> 

		<span class="bp">self</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_caption</span><span class="p">()</span>
		<span class="c">#Make the description string showing what changed since the last plot</span>
		
		<span class="c">#Reinitialize the run_on_refresh setting</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;run_model_on_refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

	<span class="k">def</span> <span class="nf">make_descstr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Makes a string which shows how the this controlstate differs from the previous one&quot;&quot;&quot;</span>
		<span class="n">thestr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
		<span class="n">thestr</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%m-</span><span class="si">%d</span><span class="s">-%Y %H:%M UT&#39;</span><span class="p">)</span>
		<span class="n">thestr</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
		<span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">]:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="n">driver</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;dt&#39;</span><span class="p">:</span>
				<span class="n">thestr</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">driver</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="n">driver</span><span class="p">]))</span>
		<span class="n">held_positionvars</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Altitude&#39;</span><span class="p">,</span><span class="s">&#39;Latitude&#39;</span><span class="p">,</span><span class="s">&#39;Longitude&#39;</span><span class="p">]</span>
		<span class="n">controlstate_positions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;alt&#39;</span><span class="p">,</span><span class="s">&#39;lat&#39;</span><span class="p">,</span><span class="s">&#39;lon&#39;</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">]:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_position</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">held_positionvars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s">&#39;var&#39;</span><span class="p">])</span>
				<span class="n">held_positionvars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
				<span class="n">controlstate_positions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">held_positionvars</span><span class="p">)):</span>
			<span class="n">thestr</span><span class="o">+=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%.2f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">held_positionvars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">controlstate_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
		<span class="n">thestr</span> <span class="o">=</span> <span class="n">thestr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># remove trailing newline</span>

		<span class="k">return</span> <span class="n">thestr</span>

	<span class="k">def</span> <span class="nf">make_caption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Writes a caption fully describing the latest graph</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c">#Build a description of the plot</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">caption</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;|&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">data_as_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Render the current plot&#39;s data as a CSV string</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;plottype&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;line&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]</span>
		<span class="n">vs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">coord</span><span class="o">+</span><span class="s">&#39;var&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]</span>
		<span class="n">data</span><span class="p">,</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">as_csv</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">,</span><span class="n">header</span>
</div>
<span class="k">class</span> <span class="nc">UiHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	A class to hold the state of the UI controls and settings.</span>
<span class="sd">	The UiHandler processes requests from the browser (i.e. GET, SET, POST)</span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c">#exposed = True</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">amwo</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">amwo</span> <span class="o">=</span> <span class="n">amwo</span> <span class="c">#Parent atmodweb object</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="o">=</span> <span class="n">ControlStateManager</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">output_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indata</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Turns output into something serializable</span>
<span class="sd">		Cherrypy is pretty good about doing this itself. Basically all I handle right now is datetime</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
			<span class="n">outdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">outdata</span><span class="p">:</span>
				<span class="n">outdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sanitize</span><span class="p">(</span><span class="n">outdata</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
			<span class="n">outdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outdata</span><span class="p">)):</span>
				<span class="n">outdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sanitize</span><span class="p">(</span><span class="n">outdata</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
			<span class="n">outdata</span> <span class="o">=</span> <span class="n">indata</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">outdata</span> <span class="o">=</span> <span class="n">indata</span>
		<span class="k">return</span> <span class="n">outdata</span>

	<span class="c">#@cherrypy.tools.accept(media=&#39;text/plain&#39;)</span>
	<span class="c">#@cherrypy.tools.json_out()</span>
	<span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statevar</span><span class="p">,</span> <span class="n">subfield</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		ReST GET request handler (i.e. browser asks backend for information and backend returns informations) </span>
<span class="sd">		Returns JSONified dictionary. </span>
<span class="sd">		The RESTful API here is all based on setting and getting values from the ControlState dictionary subclass.</span>

<span class="sd">		INPUTS</span>
<span class="sd">		------</span>
<span class="sd">			statevar - string</span>
<span class="sd">				Which key of self.controlstate will be retrieved with this request </span>
<span class="sd">			subfield - string,optional</span>
<span class="sd">				If self.controlstate[statevar] is a dictionary, then the value at self.controlstate[statevar][subfield] will</span>
<span class="sd">				be retrieved if subfield is not None</span>

<span class="sd">		RETURNS</span>
<span class="sd">		-------</span>
<span class="sd">			retjson - dict</span>
<span class="sd">				A dictionary response to the request. Has a key of the input statevar, the value of which is the desired data.</span>
<span class="sd">				Does NOT ever have a key of subfield.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">retjson</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="c">#Direct getting from ControlState</span>
		<span class="k">if</span> <span class="n">statevar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="ow">and</span> <span class="n">subfield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;GET for statevar:</span><span class="si">%s</span><span class="s"> returning </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">statevar</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">retval</span><span class="p">)))</span>
		<span class="k">elif</span> <span class="n">statevar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="ow">and</span> <span class="n">subfield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">],</span><span class="s">&#39;__getitem__&#39;</span><span class="p">):</span> <span class="c">#Must be some kind of dict like thing</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">][</span><span class="n">subfield</span><span class="p">]</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;GET for statevar:</span><span class="si">%s</span><span class="s">, key:</span><span class="si">%s</span><span class="s"> returning </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">statevar</span><span class="p">,</span><span class="n">subfield</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">retval</span><span class="p">)))</span>
			<span class="k">else</span><span class="p">:</span> <span class="c">#Just try to do the thing UNSAFE</span>
				<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">],</span><span class="n">subfield</span><span class="p">):</span>
					<span class="n">mymeth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">],</span><span class="n">subfield</span><span class="p">)</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">mymeth</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;UNSAFE GET Eval </span><span class="si">%s</span><span class="s"> = self.controlstate[</span><span class="si">%s</span><span class="s">].</span><span class="si">%s</span><span class="s">()&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">retval</span><span class="p">),</span><span class="n">statevar</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">subfield</span><span class="p">)))</span>
		<span class="k">elif</span> <span class="n">statevar</span> <span class="o">==</span> <span class="s">&#39;modeldesc&#39;</span><span class="p">:</span>
			<span class="c">#Get the description of the last run model</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;modeldesc&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mr</span><span class="o">.</span><span class="n">runs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">modeldesc</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">statevar</span> <span class="o">==</span> <span class="s">&#39;controlstate&#39;</span><span class="p">:</span>
			<span class="c">#Get the controlstate as an html table</span>
			<span class="n">retval</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
					<span class="n">retval</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">ashtml</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">statevar</span> <span class="o">==</span> <span class="s">&#39;vars&#39;</span><span class="p">:</span>
			<span class="c">#Get all of the information about the variables as one package</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]:</span>
				<span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;var&#39;</span><span class="p">,</span><span class="s">&#39;bounds&#39;</span><span class="p">,</span><span class="s">&#39;units&#39;</span><span class="p">,</span><span class="s">&#39;desc&#39;</span><span class="p">,</span><span class="s">&#39;log&#39;</span><span class="p">]:</span>
					<span class="n">retval</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">,</span><span class="n">prefix</span><span class="o">+</span><span class="n">suffix</span><span class="p">)</span> 
		<span class="k">elif</span> <span class="n">statevar</span> <span class="o">==</span> <span class="s">&#39;chartdata&#39;</span><span class="p">:</span>
			<span class="c">#Get all the data about the drivers needed for the d3 chart</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">]:</span>
				<span class="n">retval</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="n">retval</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;drivers&#39;</span><span class="p">][</span><span class="n">driver</span><span class="p">]</span>
				<span class="c">#Now loop on all</span>
				<span class="k">for</span> <span class="n">metadata_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;drivers_descriptions&#39;</span><span class="p">,</span><span class="s">&#39;drivers_units&#39;</span><span class="p">,</span><span class="s">&#39;drivers_ranges&#39;</span><span class="p">]:</span>
					<span class="k">if</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">]:</span> 	 
						<span class="n">retval</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="n">metadata_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">][</span><span class="n">driver</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">retval</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="n">metadata_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="bp">None</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Chartdata is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">retval</span><span class="p">)))</span>
		<span class="n">retjson</span><span class="p">[</span><span class="n">statevar</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_sanitize</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retjson</span>

	<span class="c">#@cherrypy.tools.accept(media=&#39;text/plain&#39;)</span>
	<span class="c">#@cherrypy.tools.json_out()</span>
	<span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posttype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		ReST POST request handler (i.e. browser tells backend information and backend does something based on that information) </span>
<span class="sd">		Returns JSONified dictionary. </span>

<span class="sd">		INPUTS</span>
<span class="sd">		------</span>
<span class="sd">			posttype - string</span>
<span class="sd">				Which POST request to evaluate</span>

<span class="sd">			</span>
<span class="sd">		RETURNS</span>
<span class="sd">		-------</span>
<span class="sd">			retjson - dict</span>
<span class="sd">				A dictionary response to the request. Gets converted to json by cherrypy. For POST requests this</span>
<span class="sd">				is kind of a dummy response, because jQuery assumes that a PUT that doesn&#39;t respond has failed.</span>
<span class="sd">				All it is is a dictionary with one field, keyed to the input statevar, and valued to True</span>
<span class="sd">		</span>
<span class="sd">		&#39;uiready&#39; - Starts controlstate syncing with CherryPy session</span>
<span class="sd">		&#39;refreshnow&#39; - Calls the FakeCanvas method &#39;refresh&#39; to process any enqued changes to the plot</span>
<span class="sd">		&#39;replotnow&#39; - Calls the AtModWebObj method &#39;replot&#39; to write the FakeCanvas matplotlib figure to a file </span>
<span class="sd">						and update the &#39;lastplot&#39; key in controlstate</span>
<span class="sd">		&#39;refreshselect&#39; - Calls the FakeCanvas method refreshSelectOptions, which checks the controlstate x, y and z vars, and the plottype and sets </span>
<span class="sd">							the appropriate possible choices of variables to plot for x, y and z</span>
<span class="sd">		&#39;refreshmodeloptions&#39; - Updates the controlstate &#39;drivers&#39; key from the last model run (ModelRun instance)</span>
<span class="sd">		&#39;debugreinit&#39; - A &#39;panic&#39;. Reinits the controlstate to its default values, and does all of the above as well. </span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">posttype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">:</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">posttype</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> returning </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">retval</span><span class="p">))</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="n">posttype</span><span class="p">:</span><span class="n">retval</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;restart&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&quot;POST for posttype: restart THE BACKEND WILL NOW RESTART&quot;</span> <span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&#39;restart&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;nextplot&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">#lastind is a property. the setter will cause the controlstate to re-sync</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&quot;POST for posttype: nextplot get plot at index </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&#39;nextplot&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;plot&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;thisplot&#39;</span><span class="p">],</span><span class="s">&#39;caption&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;thiscaption&#39;</span><span class="p">],</span>
					<span class="s">&#39;ind&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;maxind&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">states</span><span class="p">)}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;prevplot&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">#lastind is a property. the setter will cause the controlstate to re-sync</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&quot;POST for posttype: prevplot get plot at index </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&#39;prevplot&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;plot&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;thisplot&#39;</span><span class="p">],</span><span class="s">&#39;caption&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;thiscaption&#39;</span><span class="p">],</span>
					<span class="s">&#39;ind&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">lastind</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">states</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;maxind&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">states</span><span class="p">)}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;uiready&#39;</span><span class="p">:</span>
			<span class="c">#Begin syncing the local controlstate with the session</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> beginning controlstate sync&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;uiready&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;refreshnow&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> successful refresh&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;refresh&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;replotnow&#39;</span><span class="p">:</span>
			<span class="n">newfn</span><span class="p">,</span><span class="n">newcap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">replot</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> successful replot: new file=</span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">,</span><span class="n">newfn</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;src&quot;</span><span class="p">:</span><span class="n">newfn</span><span class="p">,</span><span class="s">&quot;cap&quot;</span><span class="p">:</span><span class="n">newcap</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;refreshselect&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">refreshSelectOptions</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> successful refresh select options&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;refreshselect&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;autoscale&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> successful refresh variable limits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;autoscale&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;refreshmodeloptions&#39;</span><span class="p">:</span>
			<span class="n">newfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">refreshModelRunOptions</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> successful refresh model run options&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;refreshmodeloptions&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;gifmode&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;gif_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;gif_mode&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">True</span>
			<span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;gif_mode&#39;</span><span class="p">]:</span>
				<span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amwo</span><span class="o">.</span><span class="n">make_gif</span><span class="p">()</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;gifmode&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;gif_mode&#39;</span><span class="p">],</span><span class="s">&quot;file&quot;</span><span class="p">:</span><span class="n">f</span><span class="p">}</span> 
		<span class="k">elif</span> <span class="n">posttype</span> <span class="o">==</span> <span class="s">&#39;debugreinit&#39;</span><span class="p">:</span>
			<span class="c">#This is extreme measures. Expires the CherryPy session and tries to resync it with a good version of the controlstate</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Reinitializing controlstate&quot;</span><span class="p">)</span>
			<span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">expire</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">restore_last_good</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">HEADER</span><span class="o">+</span><span class="s">&#39;POST for posttype:</span><span class="si">%s</span><span class="s"> successfully reintialized local controlstate&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">posttype</span><span class="p">)</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&quot;debugreinit&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>

	<span class="k">def</span> <span class="nf">input_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inval</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sanitize data that came from a browser PUT request. This method handles inputs that are lists (i.e passed as JS arrays),</span>
<span class="sd">		and inpus that are dicts (i.e. passed as JS objects)</span>
<span class="sd">		It calls input_sanitize_single to process individual values.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Sanitizing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">inval</span><span class="p">)))</span>
		<span class="c">#Sanitize input</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
			<span class="n">outval</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inval</span><span class="p">:</span>
				<span class="c">#Recursion FTW</span>
				<span class="n">outval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_sanitize</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inval</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
			<span class="n">outval</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inval</span><span class="p">:</span>
				<span class="c">#More recursion</span>
				<span class="n">outval</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_sanitize</span><span class="p">(</span><span class="n">inval</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
		<span class="k">elif</span> <span class="s">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">inval</span><span class="p">:</span> <span class="c">#Maybe its a string trying to represent a list</span>
			<span class="n">inval</span> <span class="o">=</span> <span class="n">inval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
			<span class="c">#Now recurse with list of strings and no commas</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">input_sanitize</span><span class="p">(</span><span class="n">inval</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">outval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_sanitize_single</span><span class="p">(</span><span class="n">inval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">outval</span>

	<span class="k">def</span> <span class="nf">input_sanitize_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Turns request data from PUT requests into something python knows what to do with. First it converts the strings from unicode</span>
<span class="sd">		to ASCII, and then trys to guess what the string is intended to be by trying to turn into an int, float, bool, or datetime.datetime</span>
<span class="sd">		using the format: Y-m-d H:M:S. If it fails all these, it just returns the string.</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c">#Convert a unicode string returned with a put into a python</span>
		<span class="c">#datatype in a sensible way</span>
		<span class="c">#Check if it&#39;s a bool</span>
		<span class="c">#First try to turn the unicode into a normal string</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c">#Remove any leading or trailing whitespace</span>

		<span class="c">#Make sure there&#39;s no spaces, parens, brackets or other nonsense</span>
		<span class="n">nonsense</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">,</span><span class="s">&#39;;&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">ns</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">nonsense</span><span class="p">]):</span>
			<span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">nonsense</span><span class="p">:</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> 
		

		<span class="c">#Check if it&#39;s just an integer</span>
		<span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> <span class="c">#isdigit returns false if theres a .</span>
			<span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="c">#Check if it&#39;s able to be turned into a float</span>
		<span class="k">elif</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span> 
			<span class="n">floatable</span><span class="o">=</span><span class="bp">True</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="n">floatable</span><span class="o">=</span><span class="bp">False</span>

		<span class="c">#Check for bool</span>
		<span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;true&#39;</span><span class="p">,</span><span class="s">&#39;True&#39;</span><span class="p">,</span><span class="s">&#39;on&#39;</span><span class="p">]:</span>
			<span class="n">val</span><span class="o">=</span><span class="bp">True</span>
		<span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;false&#39;</span><span class="p">,</span><span class="s">&#39;False&#39;</span><span class="p">,</span><span class="s">&#39;off&#39;</span><span class="p">]:</span>
			<span class="n">val</span><span class="o">=</span><span class="bp">False</span>

		<span class="c">#Try to convert it to a datetime</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Sanitizing: </span><span class="si">%s</span><span class="s"> failed to convert </span><span class="si">%s</span><span class="s"> to datetime</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
			<span class="k">pass</span>

		<span class="k">return</span> <span class="n">val</span>

	<span class="c">#@cherrypy.tools.json_out()</span>
	<span class="c">#@cherrypy.tools.accept(media=&#39;text/plain&#39;)</span>
	<span class="k">def</span> <span class="nf">PUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">statevar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">newval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		ReST PUT request handler. Returns JSONified dictionary. </span>
<span class="sd">		The RESTful API here is all based on setting and getting values from the ControlState dictionary subclass.</span>
<span class="sd">		</span>
<span class="sd">		INPUTS</span>
<span class="sd">		------</span>
<span class="sd">			statevar - string</span>
<span class="sd">				Which key of self.controlstate will be set with this request </span>
<span class="sd">			newval - anything</span>
<span class="sd">				What will be stored at self.controlstate[statevar]</span>
<span class="sd">			subfield - string,optional</span>
<span class="sd">				If self.controlstate[statevar] is a dictionary, then newval will be stored at self.controlstate[statevar][subfield] if </span>
<span class="sd">				subfield is not None</span>

<span class="sd">		RETURNS</span>
<span class="sd">		-------</span>
<span class="sd">			retjson - dict</span>
<span class="sd">				A dictionary response to the request. Gets converted to json by cherrypy. For PUT requests this</span>
<span class="sd">				is kind of a dummy response, because jQuery assumes that a PUT that doesn&#39;t respond has failed.</span>
<span class="sd">				All it is is a dictionary with one field, keyed to the input statevar, and valued to &quot;True&quot;</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">newval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">newval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_sanitize</span><span class="p">(</span><span class="n">newval</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">subfield</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c">#Top level put</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">OKBLUE</span><span class="o">+</span><span class="s">&#39;PUT request for statevar:</span><span class="si">%s</span><span class="s"> old value: </span><span class="si">%s</span><span class="s">, new value </span><span class="si">%s</span><span class="s">, type: </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">statevar</span><span class="p">),</span>
				<span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">newval</span><span class="p">)))</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">statevar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;PUT request with invalid controlstate addressee </span><span class="si">%s</span><span class="s">, data: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">statevar</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">OKBLUE</span><span class="o">+</span><span class="s">&#39;PUT request for statevar:</span><span class="si">%s</span><span class="s">, subfield:</span><span class="si">%s</span><span class="s">, old value </span><span class="si">%s</span><span class="s">, new value </span><span class="si">%s</span><span class="s">, type: </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">statevar</span><span class="p">),</span>
				<span class="nb">str</span><span class="p">(</span><span class="n">subfield</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">][</span><span class="n">subfield</span><span class="p">]),</span><span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">newval</span><span class="p">)))</span><span class="o">+</span><span class="n">ansicolors</span><span class="o">.</span><span class="n">ENDC</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">],</span><span class="s">&#39;__setitem__&#39;</span><span class="p">):</span> <span class="c">#Must be some kind of dict like thing</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">][</span><span class="n">subfield</span><span class="p">]</span> <span class="o">=</span> <span class="n">newval</span>
				<span class="c">#Have to explicitly trigger changed since we aren&#39;t explicitly </span>
				<span class="c">#setting controlstate[&#39;drivers&#39;] TODO find a better way</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="o">.</span><span class="n">trigger_changed</span><span class="p">(</span><span class="n">statevar</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="n">subfield</span><span class="p">)</span>
			<span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">],</span><span class="n">subfield</span><span class="p">):</span>
				<span class="n">myattr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="n">statevar</span><span class="p">],</span><span class="n">subfield</span><span class="p">)</span>
				<span class="n">myattr</span> <span class="o">=</span> <span class="n">newval</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;UNSAFE PUT Eval setattr(self.controlstate[</span><span class="si">%s</span><span class="s">],</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">statevar</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">subfield</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">)))</span>				
			<span class="k">else</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;PUT request with invalid controlstate addressee </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">, data: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">statevar</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">subfield</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">newval</span><span class="p">)))</span>
		<span class="c">#self.amwo.canvas.refresh()</span>
		<span class="c">#Return something to make jquery happy (a request that returns nothing has state &quot;rejected&quot;)</span>
		<span class="k">return</span> <span class="p">{</span><span class="n">statevar</span><span class="p">:</span><span class="s">&quot;True&quot;</span><span class="p">}</span>

	<span class="c">#def DELETE(self):</span>
	<span class="c">#	cherrypy.session.pop(&#39;mystring&#39;, None)</span>

<div class="viewcode-block" id="FakeCanvas"><a class="viewcode-back" href="../for_developers.html#atmodweb.FakeCanvas">[docs]</a><span class="k">class</span> <span class="nc">FakeCanvas</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The FakeCanvas is the workhorse of the backend of AtModWeb. It&#39;s called a FakeCanvas because of the project this </span>
<span class="sd">	was based off of, the AtModExplorer. This takes the place of the matplotlib canvas subclass, that </span>
<span class="sd">	preformed a similar function in atmodexplorer.</span>
<span class="sd">	It is a matplotlib canvas in the sense that it has one matplotlib figure at self.fig, and an axes at self.ax. But</span>
<span class="sd">	otherwise it&#39;s just a convenient way of organizing the code and has nothing to do with Matplotlib.</span>
<span class="sd">	It&#39;s important parameters are the PlotDataHandler instance as self.pdh, and the ControlState instance at self.controlstate</span>
<span class="sd">	It&#39;s parent, the AtModWebObj that ties the application together is at self.atmo. It shares it&#39;s controlstate with the UiHandler,</span>
<span class="sd">	which handles requests.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atmo</span><span class="p">):</span>		
		<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span> <span class="o">=</span> <span class="n">atmo</span> <span class="c">#&quot;parent&quot; atmodwebobject</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="s">&#39;caption&#39;</span> <span class="c"># Caption for the figure, created by make_caption </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">textobj</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">def</span> <span class="nf">apply_lipstick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called on each replot, allows cosmetic adjustment&quot;&quot;&quot;</span>
		<span class="c">#self.fig.subplots_adjust(left=0.05,bottom=0.05,top=.95,right=.95)</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="mi">9</span>
		<span class="n">w</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
		<span class="n">lw</span> <span class="o">=</span> <span class="o">.</span><span class="mi">3</span>
		<span class="n">lp</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">pd</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottype</span><span class="o">==</span><span class="s">&#39;pcolor&#39;</span><span class="p">:</span>

			<span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xmajorticklabels</span><span class="p">(),</span><span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
			<span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">(),</span><span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
			<span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xmajorticklabels</span><span class="p">(),</span><span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
						
			<span class="c">#Label is a text object</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">labelpad</span><span class="o">=</span><span class="n">lp</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">labelpad</span><span class="o">=</span><span class="n">lp</span>
			
			<span class="c">#Adjust tick size</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>

			<span class="c">#Colorbar Ticks</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>
			<span class="c">#Adjust axes border size</span>
			<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="s">&#39;bottom&#39;</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="s">&#39;right&#39;</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>
				<span class="c">#self.pdh.cb.spines[axis].set_linewidth(lw)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s">&#39;bold&#39;</span><span class="p">)</span>
			
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottype</span><span class="o">==</span><span class="s">&#39;map&#39;</span><span class="p">:</span>
			<span class="c">#Colorbar Ticks</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s">&#39;bold&#39;</span><span class="p">)</span>

			<span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xmajorticklabels</span><span class="p">(),</span><span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
						<span class="c">#Adjust axes border size</span>
			<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="s">&#39;bottom&#39;</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="s">&#39;right&#39;</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>

		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">plottype</span><span class="o">==</span><span class="s">&#39;line&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s">&#39;bold&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span><span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
			<span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atmo</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">pdh</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xmajorticklabels</span><span class="p">(),</span><span class="n">size</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
						<span class="c">#Adjust axes border size</span>
			<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="s">&#39;bottom&#39;</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="s">&#39;right&#39;</span><span class="p">]:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>


	<span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Displays text on the figure in figure coordinates (0,0) is bottom left, (1,1) is top right&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">textobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">textobj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">textobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AtModWebObj"><a class="viewcode-back" href="../for_developers.html#atmodweb.AtModWebObj">[docs]</a><span class="k">class</span> <span class="nc">AtModWebObj</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The AtModWebObj class is a representation of a single user session of AtModWeb.</span>
<span class="sd">	It includes all of the pieces required for a user with the AtModWeb webpage open in their browser</span>
<span class="sd">	to generate plots and interact with the data.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">userid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">userid</span> <span class="o">=</span> <span class="n">userid</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">time_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">last_accessed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">gif_frames</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n_max_plots</span> <span class="o">=</span> <span class="mi">20</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n_total_plots</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="c">#Start up the rest of the application</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span> <span class="o">=</span> <span class="n">UiHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span><span class="o">.</span><span class="n">controlstate</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">FakeCanvas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">syncher</span> <span class="o">=</span> <span class="n">Synchronizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">force_full_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="n">plots</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rootdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">imgreldir</span><span class="p">,</span><span class="s">&#39;amwo_</span><span class="si">%s</span><span class="s">_*.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userid</span><span class="p">))))</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_max_plots</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">plots</span><span class="p">)</span> <span class="c">#Clean up after yourself on restart</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">plots</span> <span class="o">=</span>  <span class="p">[]</span> <span class="c">#List of all plots in the img dir</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">replot</span><span class="p">()</span>


	<span class="k">def</span> <span class="nf">replot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		The last step in the creation of a new plot to be displayed in the frontend.</span>

<span class="sd">		This function, when called, writes the FakeCanvas&#39; matplotlib figure</span>
<span class="sd">		to a file on the disk, the name of which is dependent on the current unix time.</span>
<span class="sd">		The URL for the file (as a relative path) is then recorded in the controlstate,</span>
<span class="sd">		and returned to the caller (usually the UiHandler, which then relays it to the frontend in </span>
<span class="sd">		a HTTP response). </span>
<span class="sd">		Does several other incidental labeling tasks, and also returns a &#39;caption&#39; for the</span>
<span class="sd">		graphic. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c">#self.canvas.refresh(force_full_refresh=True)</span>
		<span class="c">#Name file with unix epoch and userid</span>
		<span class="n">relfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">imgreldir</span><span class="p">,</span><span class="s">&#39;amwo_</span><span class="si">%s</span><span class="s">_</span><span class="si">%d</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userid</span><span class="p">),</span>
			<span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))))</span>
		<span class="n">absfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rootdir</span><span class="p">,</span><span class="n">relfn</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;gif_mode&#39;</span><span class="p">]:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gif_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absfn</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">.</span><span class="mo">01</span><span class="p">,</span><span class="o">.</span><span class="mi">94</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;descstr&#39;</span><span class="p">],</span>
			<span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">verticalalignment</span><span class="o">=</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span>
			<span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="s">&#39;round&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">8</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">absfn</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
		<span class="c">#self.canvas.fig.clf()</span>
		<span class="c">#self.canvas.ax = self.canvas.fig.add_subplot(111)</span>
		<span class="c">#Generate caption</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">caption</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;thiscaption&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">cap</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">[</span><span class="s">&#39;thisplot&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">relfn</span>
		<span class="c">#Deal with the plot and caption history</span>
		<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_max_plots</span><span class="p">:</span>	
			<span class="n">tobedeleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rootdir</span><span class="p">,</span><span class="n">tobedeleted</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;REMOVED old plot </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tobedeleted</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Replotted to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">absfn</span><span class="p">))</span>

		<span class="c">#Store the controlstate that was used to make the plot</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span><span class="p">()</span> <span class="c"># store the last controlstate as states[-1]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n_total_plots</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">return</span> <span class="n">relfn</span><span class="p">,</span> <span class="n">cap</span>

	<span class="k">def</span> <span class="nf">make_gif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gif</span><span class="o">=</span><span class="s">&#39;out.gif&#39;</span><span class="p">,</span><span class="n">delay</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">delete_imgs</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Converts a list of pngs, in order, to frames for a gif</span>
<span class="sd">			imgs - list of valid png or jpg paths</span>
<span class="sd">			gif - gif file to write to</span>
<span class="sd">			tempdir - directory where temporary frame pngs will be stored</span>
<span class="sd">			delay - time in milliseconds each frame will display for</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gif_frames</span>
		<span class="n">tempdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">rootdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">imgreldir</span><span class="p">)</span>
		<span class="c">#if not is_ImageMagick_Installed():</span>
		<span class="c">#	raise RuntimeError(&quot;ImageMagick appears to not be installed! If on Ubuntu, try sudo apt-get install imagemagick\n&quot;)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Now beginning to copy files to temporary frames for gif. Temporary directory is </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tempdir</span><span class="p">))</span>
		<span class="n">paddingcode</span> <span class="o">=</span> <span class="s">&#39;%.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))))</span><span class="o">+</span><span class="s">&#39;d&#39;</span> <span class="c">#imagemagick needs zero padded frame numbering</span>
		
		<span class="n">imgext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">tmpimgs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
			<span class="n">tmpimg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span><span class="s">&quot;img2gif_frame_&quot;</span><span class="o">+</span><span class="n">paddingcode</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">imgext</span><span class="p">)</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">tmpimg</span><span class="p">)</span>
			<span class="n">tmpimgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpimg</span><span class="p">)</span>

		<span class="n">imcall</span> <span class="o">=</span> <span class="s">&quot;convert -delay </span><span class="si">%d</span><span class="s"> -loop 0 </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delay</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span><span class="s">&#39;img2gif_frame_*&#39;</span><span class="o">+</span><span class="n">imgext</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span><span class="n">gif</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Calling ImageMagick to convert frames to gif...&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Call is </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imcall</span><span class="p">))</span>
		<span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">imcall</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Cleaning up temp files...&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">tmpimg</span> <span class="ow">in</span> <span class="n">tmpimgs</span><span class="p">:</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpimg</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">gif_frames</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">imgreldir</span><span class="p">,</span><span class="n">gif</span><span class="p">)</span>
		<span class="c">#if open_gif:</span>
		<span class="c">#	subprocess.check_call(&quot;xdg-open %s&quot; % (gif))</span>

	<span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A full &#39;hard&#39; restart of the backend. Destroys and recreates all of </span>
<span class="sd">		the instances of the AtModWeb components (FakeCanvas, UiHandler, Synchronizer) </span>
<span class="sd">		for this single user. Called if UiHandler receives {posttype:&#39;restart&#39;} as a POST request</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c">#A full scale panic restart</span>
		<span class="c">#Just reinitalize all the things</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;---RESTARTING THE BACKEND---&quot;</span><span class="p">)</span>
		<span class="c">#cherrypy.lib.sessions.expire()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span> <span class="o">=</span> <span class="n">UiHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">controlstate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span><span class="o">.</span><span class="n">controlstate</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">FakeCanvas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">syncher</span> <span class="o">=</span> <span class="n">Synchronizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">force_full_refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">replot</span><span class="p">()</span>
		

</div>
<span class="k">class</span> <span class="nc">UiDispatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Makes sure that requests from a particular user&#39;s session </span>
<span class="sd">	get dispatched to the proper instances of UiHandler and AtModWebObj</span>
<span class="sd">	that contains their plot history. Helps make AtModWeb multiuser.</span>
<span class="sd">	a.k.a dispatches requests to the approriate uihandler as </span>
<span class="sd">	specified by the userid cookie.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">exposed</span> <span class="o">=</span> <span class="bp">True</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">muamwo</span><span class="p">):</span>
		<span class="c">#This needs to be done here (before the UiDispatcher is created) so that CherryPy</span>
		<span class="c">#knows that tools.auth is a thing before it&#39;s used in UiDispatcher </span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span> <span class="o">=</span> <span class="n">muamwo</span>

	<span class="k">def</span> <span class="nf">get_uihandler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">get_user_amwo</span><span class="p">()</span><span class="o">.</span><span class="n">uihandler</span>

	<span class="k">def</span> <span class="nf">get_amwo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">get_user_amwo</span><span class="p">()</span>

	<span class="nd">@cherrypy.tools.accept</span><span class="p">(</span><span class="n">media</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
	<span class="nd">@cherrypy.tools.json_out</span><span class="p">()</span>
	<span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statevar</span><span class="p">,</span> <span class="n">subfield</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">statevar</span> <span class="o">==</span> <span class="s">&#39;username&#39;</span><span class="p">:</span>
			<span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">get_userid</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">return</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">uid</span><span class="p">]}</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uihandler</span><span class="p">()</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">statevar</span><span class="o">=</span><span class="n">statevar</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="n">subfield</span><span class="p">)</span>
		
	<span class="nd">@cherrypy.tools.json_out</span><span class="p">()</span>
	<span class="nd">@cherrypy.tools.accept</span><span class="p">(</span><span class="n">media</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
	<span class="k">def</span> <span class="nf">PUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">statevar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">newval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uihandler</span><span class="p">()</span><span class="o">.</span><span class="n">PUT</span><span class="p">(</span><span class="n">statevar</span><span class="o">=</span><span class="n">statevar</span><span class="p">,</span><span class="n">newval</span><span class="o">=</span><span class="n">newval</span><span class="p">,</span><span class="n">subfield</span><span class="o">=</span><span class="n">subfield</span><span class="p">)</span>

	<span class="nd">@cherrypy.tools.accept</span><span class="p">(</span><span class="n">media</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
	<span class="nd">@cherrypy.tools.json_out</span><span class="p">()</span>
	<span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">posttype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="s">&#39;authenticate_&#39;</span> <span class="ow">in</span> <span class="n">posttype</span><span class="p">:</span>
			<span class="n">un</span> <span class="o">=</span> <span class="n">posttype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;authenticate_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Anything after is username</span>
			<span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">newuserid</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="n">un</span>
			<span class="n">respcookie</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span>
			<span class="n">respcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">userid</span>
			<span class="n">respcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">][</span><span class="s">&#39;max-age&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">3630</span>
			<span class="k">return</span> <span class="p">{</span><span class="n">posttype</span><span class="p">:</span><span class="s">&#39;true&#39;</span><span class="p">}</span>
		<span class="k">elif</span> <span class="s">&#39;kill_&#39;</span> <span class="ow">in</span> <span class="n">posttype</span><span class="p">:</span>
			<span class="n">uid</span> <span class="o">=</span> <span class="n">posttype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;kill_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">_usernames</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">userids</span><span class="o">=</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Recieved kill POST for nonexistant userid </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uid</span><span class="p">))</span>
		<span class="k">elif</span> <span class="s">&#39;logout&#39;</span> <span class="o">==</span> <span class="s">&#39;posttype&#39;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
			<span class="k">return</span> <span class="p">{</span><span class="s">&#39;logout&#39;</span><span class="p">:</span><span class="s">&#39;true&#39;</span><span class="p">}</span>
		<span class="k">else</span><span class="p">:</span> <span class="c">#Push on to appropriate handler</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uihandler</span><span class="p">()</span><span class="o">.</span><span class="n">POST</span><span class="p">(</span><span class="n">posttype</span><span class="o">=</span><span class="n">posttype</span><span class="p">)</span>
	

<span class="k">class</span> <span class="nc">MultiUserAtModWebObj</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Thin class to spin up AtModWebObj instances when a request comes in from a new user&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c"># AtModWeb instances</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="c">#Application Location</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uihandler</span> <span class="o">=</span> <span class="n">UiDispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;ATMODWEB_ROOT_DIR&#39;</span><span class="p">]</span> 
		<span class="bp">self</span><span class="o">.</span><span class="n">imgreldir</span> <span class="o">=</span> <span class="s">&#39;www&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">docreldir</span> <span class="o">=</span> <span class="s">&#39;docs&#39;</span>

	<span class="nd">@cherrypy.expose</span>
	<span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">get_user_amwo</span><span class="p">()</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>
		<span class="k">return</span> <span class="s">&quot;&quot;&quot;&lt;html&gt;Restarting done. &lt;/html&gt;&quot;&quot;&quot;</span>

	<span class="nd">@cherrypy.expose</span>
	<span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_userid</span><span class="p">()</span>
		<span class="c">#Organize the parameters for each AtModWeb as a table row</span>
		<span class="n">th</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">th</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Time Created&#39;</span>
		<span class="n">th</span><span class="p">[</span><span class="s">&#39;accessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Last Accessed&#39;</span>
		<span class="n">th</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Username&#39;</span>
		<span class="n">th</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;User ID Number&#39;</span>
		<span class="n">th</span><span class="p">[</span><span class="s">&#39;nplots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Number of Plots Created&#39;</span>
		<span class="n">th</span><span class="p">[</span><span class="s">&#39;kill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Kill Session&#39;</span>
		<span class="n">tr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="c">#OrderedDict for table rows</span>
		<span class="n">retstr</span> <span class="o">=</span> <span class="s">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>
		<span class="c">#Handle the kill buttons</span>
		<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">		&lt;link href=&quot;www/atmodweb.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;</span>
<span class="s">		&lt;script src=&quot;http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="s">		&lt;script&gt; </span>
<span class="s">		$(document).ready(function(){</span>
<span class="s">			$(&#39;.killer&#39;).on(&quot;click&quot;, function (e) {</span>
<span class="s">				var id = $(e.target).attr(&#39;name&#39;);</span>
<span class="s">				console.log(&#39;Killing &#39;+String(id))</span>
<span class="s">				var doingthething = $.ajax({url: &quot;/uihandler&quot;,data: {&quot;posttype&quot;:&quot;kill_&quot;+String(id)},type: &quot;POST&quot;,dataType:&quot;json&quot;,</span>
<span class="s">					success : function (json) {</span>
<span class="s">						$(e.target).text(&#39;KILLED&#39;)</span>
<span class="s">						console.log(&#39;Kill success&#39;)</span>
<span class="s">					}</span>
<span class="s">				})</span>
<span class="s">			});</span>
<span class="s">		});</span>
<span class="s">		&lt;/script&gt;</span>
<span class="s">		&quot;&quot;&quot;</span>
		<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&#39;&lt;div ID=&quot;locationpanel&quot; class=&quot;panel&quot;&gt;&#39;</span>
		<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&#39;&lt;h1&gt;Admin Interface for AtModWeb&lt;/h1&gt;&#39;</span>
		<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&#39;&lt;p&gt;If you are not the administrator of this application, you should not be here.&lt;/p&gt;&#39;</span>
		<span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;liam&#39;</span><span class="p">:</span>
			<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;h1&gt; Currently running amwo instances: &lt;/h1&gt;&quot;</span> 
			<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;table&gt;&quot;</span>
			<span class="c">#Add headers to the table</span>
			<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;tr&gt;&quot;</span>
			<span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">th</span><span class="p">:</span>
				<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;th&gt;</span><span class="si">%s</span><span class="s">&lt;/th&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>	
			<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">:</span>
				<span class="n">tr</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span> <span class="k">else</span> <span class="s">&#39;NO-USERNAME&#39;</span>
				<span class="n">tr</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">time_created</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%c</span><span class="s">&#39;</span><span class="p">)</span>
				<span class="n">tr</span><span class="p">[</span><span class="s">&#39;accessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">last_accessed</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%c</span><span class="s">&quot;</span><span class="p">)</span>
				<span class="n">tr</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&lt;strong&gt;</span><span class="si">%s</span><span class="s">&lt;/strong&gt;&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="c"># Make the username stand out</span>
				<span class="n">tr</span><span class="p">[</span><span class="s">&#39;nplots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">n_total_plots</span><span class="p">)</span>
				<span class="n">tr</span><span class="p">[</span><span class="s">&#39;kill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;button ID=&#39;kill_</span><span class="si">%s</span><span class="s">&#39; class=&#39;killer&#39; name=&#39;</span><span class="si">%s</span><span class="s">&#39; title=&quot;Kill this user&#39;s session&quot;&gt;KILL&lt;/button&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span>
					<span class="n">key</span><span class="p">)</span>
				<span class="c">#Add a row to the table</span>
				<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;tr&gt;&quot;</span>
				<span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">th</span><span class="p">:</span>
					<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;td class=&#39;</span><span class="si">%s</span><span class="s">&#39;&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>	
				<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;/tr&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&#39;&lt;/table&gt;&#39;</span> 
			<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&#39;&lt;/div&gt;&#39;</span>
		<span class="n">retstr</span> <span class="o">+=</span> <span class="s">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>
		<span class="k">return</span> <span class="n">retstr</span>

	<span class="nd">@cherrypy.expose</span>
	<span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s">&#39;text/csv&#39;</span>
		<span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_userid</span><span class="p">()</span>
		<span class="n">data</span><span class="p">,</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_amwo</span><span class="p">()</span><span class="o">.</span><span class="n">syncher</span><span class="o">.</span><span class="n">data_as_csv</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">header</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">data</span>

	<span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">userids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Kill all specified instance or if userids is not kills any instances that haven&#39;t been touched in an hour&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">userids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">userids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">userid</span> <span class="ow">in</span> <span class="n">userids</span><span class="p">:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span><span class="o">.</span><span class="n">last_accessed</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">3600</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Session is too old and will be killed for </span><span class="si">%s</span><span class="s">: uid </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">],</span><span class="n">userid</span><span class="p">))</span>
					<span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">userid</span><span class="p">])</span> 
					<span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">])</span>
					<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">userid</span> <span class="ow">in</span> <span class="n">userids</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Forced to end session for </span><span class="si">%s</span><span class="s">: uid </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">],</span><span class="nb">str</span><span class="p">(</span><span class="n">userid</span><span class="p">)))</span>
				<span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">userid</span><span class="p">])</span>
				<span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">])</span>
				<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

	<span class="c">#Authorization tool</span>
	<span class="c">#This is called whenever a request comes in via a CherryPy Tool</span>
	<span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;A tool that looks for a userid cookie, and makes sure that the cookie has an entry in the _usernames&quot;&quot;&quot;</span>
		<span class="n">reqcookie</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span>
		<span class="k">if</span> <span class="s">&#39;userid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reqcookie</span><span class="p">:</span>
			<span class="c">#No userid set</span>
			<span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newuserid</span><span class="p">()</span> <span class="c">#Create a new userid and assign it to the user</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;--pending--&#39;</span>
			<span class="n">respcookie</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span>
			<span class="n">respcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">userid</span>
			<span class="n">respcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">][</span><span class="s">&#39;max-age&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">3630</span>
			<span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPRedirect</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c">#No username registered to userid</span>
			<span class="n">userid</span> <span class="o">=</span> <span class="n">reqcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
			<span class="k">if</span> <span class="n">userid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;--pending--&#39;</span>
				<span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPRedirect</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">muamwo</span><span class="o">.</span><span class="n">get_userid</span><span class="p">()</span>
		<span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
		<span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
		<span class="n">respcookie</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span>
		<span class="n">respcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">][</span><span class="s">&#39;max-age&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
		<span class="n">respcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">][</span><span class="s">&#39;expires&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s">-%b-%Y %T GMT&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
		<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">newuserid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">get_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">reqcookie</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span>
		
		<span class="c">#Safety checks</span>
		<span class="k">if</span> <span class="s">&#39;userid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reqcookie</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">None</span>
		
		<span class="n">userid</span> <span class="o">=</span> <span class="n">reqcookie</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
		<span class="k">if</span> <span class="n">userid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usernames</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;--pending--&#39;</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">None</span>

		<span class="c">#self.log.info(&quot;Request sent to AMWO with userid cookie %s, method %s&quot; % (str(userid),str(cherrypy.request.method)))</span>

		<span class="k">if</span> <span class="n">userid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtModWebObj</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">userid</span><span class="o">=</span><span class="n">userid</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Spun up new AMWO instance with userid </span><span class="si">%s</span><span class="s">, there are now </span><span class="si">%d</span><span class="s"> instances running&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">userid</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
		
		<span class="c">#self.log.debug(&quot;Username for id %s is %s&quot; % (str(userid),str(self._usernames[userid])))</span>
		<span class="k">return</span> <span class="n">userid</span>

	<span class="k">def</span> <span class="nf">get_user_amwo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_userid</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="c">#Update the last accessed time</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span><span class="o">.</span><span class="n">last_accessed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amwo</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPRedirect</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
		

	<span class="n">webapp</span> <span class="o">=</span> <span class="n">MultiUserAtModWebObj</span><span class="p">()</span>
	<span class="n">cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">Tool</span><span class="p">(</span><span class="s">&#39;before_handler&#39;</span><span class="p">,</span><span class="n">webapp</span><span class="o">.</span><span class="n">check_auth</span><span class="p">)</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="p">{</span>
		 <span class="s">&#39;/&#39;</span><span class="p">:</span> <span class="p">{</span>
			<span class="s">&#39;tools.sessions.on&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
			<span class="c">#&#39;tools.sessions.storage_type&#39;:&quot;memcached&quot;,</span>
			<span class="s">&#39;tools.sessions.locking&#39;</span><span class="p">:</span><span class="s">&#39;implicit&#39;</span><span class="p">,</span>
			<span class="s">&#39;tools.auth.on&#39;</span><span class="p">:</span> <span class="bp">True</span>
		 <span class="p">},</span>
		 <span class="s">&#39;/index&#39;</span><span class="p">:</span> <span class="p">{</span>
			<span class="s">&#39;tools.staticfile.on&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
			<span class="s">&#39;tools.staticfile.filename&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">rootdir</span><span class="p">),</span><span class="s">&#39;www&#39;</span><span class="p">,</span><span class="s">&#39;atmodweb.html&#39;</span><span class="p">)</span>
		 <span class="p">},</span>
		 <span class="s">&#39;/login&#39;</span><span class="p">:</span> <span class="p">{</span>
			<span class="s">&#39;tools.staticfile.on&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
			<span class="s">&#39;tools.staticfile.filename&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">rootdir</span><span class="p">),</span><span class="s">&#39;www&#39;</span><span class="p">,</span><span class="s">&#39;login.html&#39;</span><span class="p">)</span>
		 <span class="p">},</span>
		 <span class="s">&#39;/uihandler&#39;</span><span class="p">:</span> <span class="p">{</span>
			 <span class="s">&#39;request.dispatch&#39;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">MethodDispatcher</span><span class="p">(),</span>
			 <span class="s">&#39;tools.response_headers.on&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
			 <span class="s">&#39;tools.response_headers.headers&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span><span class="p">)],</span>

		 <span class="p">},</span>
		 <span class="s">&#39;/www&#39;</span><span class="p">:</span> <span class="p">{</span>
			 <span class="s">&#39;tools.staticdir.on&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
			 <span class="s">&#39;tools.staticdir.dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">rootdir</span><span class="p">),</span><span class="s">&#39;www&#39;</span><span class="p">)</span>
		 <span class="p">},</span>
		 <span class="s">&#39;/docs&#39;</span><span class="p">:</span> <span class="p">{</span>
			 <span class="s">&#39;tools.staticdir.on&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
			 <span class="s">&#39;tools.staticdir.dir&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">rootdir</span><span class="p">),</span><span class="s">&#39;doc&#39;</span><span class="p">,</span><span class="s">&#39;build&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">)</span>
		 <span class="p">},</span>
		 <span class="s">&#39;/favicon.ico&#39;</span><span class="p">:</span> <span class="p">{</span>
			<span class="s">&#39;tools.staticfile.on&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
			<span class="s">&#39;tools.staticfile.filename&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">rootdir</span><span class="p">),</span><span class="s">&quot;www&quot;</span><span class="p">,</span><span class="s">&quot;favicon.ico&quot;</span><span class="p">)</span>
		 <span class="p">}</span>
	 <span class="p">}</span>

	<span class="c">#Optional password protection by setting some environent variables</span>
	<span class="k">if</span> <span class="s">&#39;CHERRYPY_USER&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s">&#39;CHERRYPY_PWD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
		<span class="n">USERS</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CHERRYPY_USER&#39;</span><span class="p">]:</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CHERRYPY_PWD&#39;</span><span class="p">]}</span>
		<span class="n">conf</span><span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">][</span><span class="s">&#39;tools.auth_digest.on&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
		<span class="n">conf</span><span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">][</span><span class="s">&#39;tools.auth_digest.realm&#39;</span><span class="p">]</span><span class="o">=</span><span class="s">&#39;localhost&#39;</span>
		<span class="n">conf</span><span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">][</span><span class="s">&#39;tools.auth_digest.get_ha1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">auth_digest</span><span class="o">.</span><span class="n">get_ha1_dict_plain</span><span class="p">(</span><span class="n">USERS</span><span class="p">)</span>
		<span class="n">conf</span><span class="p">[</span><span class="s">&#39;/&#39;</span><span class="p">][</span><span class="s">&#39;tools.auth_digest.key&#39;</span><span class="p">]</span><span class="o">=</span><span class="s">&#39;b565d27146791cfc&#39;</span>
		
	<span class="n">cherrypy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;server.socket_host&#39;</span><span class="p">:</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;CHERRYPY_IP&#39;</span><span class="p">),</span><span class="s">&#39;server.socket_port&#39;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">})</span>
	<span class="n">cherrypy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;log.screen&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">})</span>

	<span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">access_log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span>

	<span class="n">cherrypy</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">webapp</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">conf</span><span class="p">)</span>
	<span class="n">cherrypy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
	<span class="n">cherrypy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">block</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">AtModWeb 0.1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Liam Kilcommons (CU Boulder Aerospace / CCAR SEDA).
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>